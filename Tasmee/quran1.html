<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…ØµØ­Ø­ Ù†ÙØ­Ø§Øª | Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --main: #1a5d1a; 
            --gold: #b8860b; 
            --gold-bright: #d4af37;
            --navy: #001f3f;
            --bg: #fdfaf1;   
            --card: #ffffff; 
            --red: #e74c3c; 
            --blue: #3498db;
            --purple: #9b59b6;
            --text: #2c3e50; 
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 15px 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }

        .header { text-align: center; margin-bottom: 20px; }
        .header img { width: 85px; filter: drop-shadow(0 3px 6px rgba(0,0,0,0.15)); transition: 0.3s; } /* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù„ÙˆØ¬Ùˆ */
        .header h1 { color: var(--main); font-size: 1.2rem; margin-top: 8px; font-weight: 900; }

        .top-controls { width: 100%; max-width: 450px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 8px; }
        .selector-row { display: flex; gap: 5px; width: 100%; align-items: stretch; }

        .surah-selector, .quarter-selector, .btn-random-choice, .btn-view-quran-small { 
            height: 42px; 
            padding: 0 5px; 
            border-radius: 12px; 
            font-weight: 700; 
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .surah-selector { 
            flex: 1.8; background: var(--card); color: var(--main); border: 2px solid var(--main); 
            cursor: pointer; appearance: none;
        }
        
        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© Ø§Ù„Ù…ØµÙ…ØªØ© */
        .quarter-selector { 
            background: var(--gold-bright); 
            color: var(--navy); 
            border: 2px solid var(--gold); 
            display: none; 
            width: 100%; 
            margin-top: 5px; 
            font-weight: 900;
            box-shadow: 0 4px 10px rgba(184, 134, 11, 0.2);
        }

        .btn-random-choice {
            flex: 1; background: var(--main); color: #fff; border: none;
            cursor: pointer; transition: 0.2s; box-shadow: 0 3px 0 #0d3d0d;
        }

        .btn-view-quran-small { 
            flex: 0.9; background: var(--card); color: var(--gold); border: 2px solid var(--gold);
            cursor: pointer; gap: 2px;
        }

        .heat-map { display: flex; width: 100%; max-width: 450px; height: 8px; background: #e0d5b1; border-radius: 10px; margin-bottom: 15px; overflow: hidden; border: 1px solid rgba(0,0,0,0.05); }
        .heat-unit { flex: 1; border-right: 1px solid rgba(255,255,255,0.3); background: #eee; transition: 0.5s; }

        .quran-card {
            width: 100%; max-width: 450px; background: var(--card); border-radius: 20px;
            padding: 25px; border: 1px solid #e0d5b1; position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .aya-display {
            font-family: 'Amiri', serif; font-size: 1.4rem; line-height: 2.1; min-height: 110px;
            display: flex; align-items: center; justify-content: center; text-align: center; 
            margin-bottom: 20px; color: var(--main); font-weight: 700;
        }
        .is-hidden { opacity: 0 !important; }

        .info-card-box { display: none; background: var(--bg); border: 1px solid var(--gold); border-radius: 12px; padding: 12px; margin-bottom: 15px; font-size: 0.75rem; color: var(--main); text-align: center; line-height: 1.6; }

        .tafseer-box, .karim-box { display: none; border-radius: 15px; padding: 15px; margin-bottom: 15px; font-size: 0.9rem; line-height: 1.7; text-align: justify; }
        .tafseer-box { background: #f4f9f4; border: 1px solid var(--main); color: var(--text); }
        .karim-box { background: #f0f7fc; border: 1px solid var(--blue); color: var(--text); border-right: 4px solid var(--blue); }

        .timer-box { font-size: 0.8rem; color: var(--gold); margin-bottom: 10px; text-align: center; font-weight: bold; }

        .controls-container {
            width: 100%;
            max-width: 450px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn { 
            width: 100%; 
            height: 48px; 
            border: none; 
            border-radius: 12px; 
            font-weight: 900; 
            font-size: 1.1rem; 
            cursor: pointer; 
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-main { background: var(--main); color: #fff; box-shadow: 0 4px 0 #0d3d0d; }
        .btn-main:active { transform: translateY(2px); box-shadow: 0 1px #0d3d0d; }
        
        .action-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
        }
        
        .btn-tool { 
            height: 44px; 
            border-radius: 10px; 
            border: none; 
            font-weight: bold; 
            font-size: 0.8rem; 
            cursor: pointer; 
            color: white; 
            display: flex; 
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 5px;
        }
        .btn-saadi { background: #27ae60; }
        .btn-karim { background: var(--blue); }
        .btn-audio-help { background: #e67e22; }
        .btn-hint { background: var(--purple); }

        .btn-save { background: transparent; color: var(--main); font-size: 0.85rem; border-radius: 12px; width: 100%; border: 2px solid var(--main); cursor: pointer; font-weight: bold; margin-top: 5px; }

        .guide-section {
            width: 100%; max-width: 450px; background: #fff; border-radius: 20px;
            padding: 20px; margin-top: 30px; border: 1px solid #e0d5b1;
            box-shadow: 0 10px 30px rgba(26, 93, 26, 0.05);
        }
        .guide-title { color: var(--main); font-weight: 900; font-size: 1.05rem; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; border-bottom: 2px solid var(--bg); padding-bottom: 10px; }
        .guide-item { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 12px; font-size: 0.85rem; line-height: 1.6; }
        .guide-dot { width: 8px; height: 8px; background: var(--gold); border-radius: 50%; margin-top: 8px; flex-shrink: 0; }
        .guide-label { font-weight: 800; color: var(--main); min-width: 80px; }

        .quran-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 1000; flex-direction: column; overflow-y: auto; padding: 20px; }
        .quran-modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--gold); padding-bottom: 10px; margin-bottom: 20px; }
        .close-modal { background: var(--red); color: white; border: none; border-radius: 8px; padding: 8px 15px; font-weight: bold; cursor: pointer; }

        .hint-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; padding: 20px;
        }
        .hint-3d-card {
            background: var(--card); width: 100%; max-width: 320px; border-radius: 20px;
            padding: 25px; text-align: center; border-bottom: 5px solid var(--purple);
        }
        .hint-word { font-family: 'Amiri', serif; font-size: 1.8rem; color: var(--main); font-weight: bold; margin: 20px 0; }
        .close-hint-btn { background: var(--purple); color: white; border: none; padding: 10px 25px; border-radius: 10px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="hintOverlay" class="hint-overlay">
    <div class="hint-3d-card">
        <h3 style="color:var(--purple)">Ù…ÙØªØ§Ø­ Ø§Ù„Ø«Ø¨Ø§Øª</h3>
        <div id="hintWordContent" class="hint-word"></div>
        <p style="font-size: 0.8rem; color: #666; margin-bottom: 20px;">Ø§Ø³ØªØ¹Ù† Ø¨Ø§Ù„Ù„Ù‡ ÙˆØ£ÙƒÙ…Ù„ Ø§Ù„Ø¢ÙŠØ©...</p>
        <button class="close-hint-btn" onclick="closeHint()">ÙÙ‡Ù…Øª</button>
    </div>
</div>

<div class="header">
    <img src="../leader/LogoNafahat.png" alt="Logo">
    <h1>Ù…ØµØ­Ø­ Ø§Ù„Ù†ÙØ­Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„</h1>
</div>

<div class="top-controls">
    <div class="selector-row">
        <select id="surahSelect" class="surah-selector">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø©...</option>
        </select>
        <button id="randomBtn" class="btn-random-choice" onclick="pickRandomAya()">Ø§Ø®ØªØ§Ø±ÙˆØ§ Ù„ÙŠ</button>
        <button class="btn-view-quran-small" onclick="openQuranModal()">ğŸ“– Ø§Ù„Ù…ØµØ­Ù</button>
    </div>
    <select id="quarterSelect" class="quarter-selector">
        <option value="0">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø³ÙˆØ±Ø©</option>
    </select>
</div>

<div class="heat-map" id="heatMap"></div>

<div class="quran-card">
    <div class="timer-box">Ø²Ù…Ù† Ø§Ù„Ø§Ø³ØªØ­Ø¶Ø§Ø±: <span id="timer">0.0</span> Ø«Ø§Ù†ÙŠØ©</div>
    <div id="infoCardBox" class="info-card-box"></div>
    <div id="tafseerSaadi" class="tafseer-box"></div>
    <div id="karimBox" class="karim-box"></div>
    <div id="ayaText" class="aya-display is-hidden">Ø¨Ø§Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…</div>
</div>

<div class="controls-container">
    <button id="actionBtn" class="btn btn-main">Ø§ÙƒØ´Ù Ø§Ù„Ø¢ÙŠØ©</button>
    
    <div class="action-grid">
        <button id="saadiBtn" class="btn-tool btn-saadi" onclick="getSaadiTafseer()">ğŸ“– Ø§Ù„ØªÙØ³ÙŠØ± ÙˆØ§Ù„Ù†Ø²ÙˆÙ„</button>
        <button id="karimBtn" class="btn-tool btn-karim" onclick="getKarimGuidance()">ğŸ™ï¸ Ø¥Ø±Ø´Ø§Ø¯Ø§Øª ÙƒØ±ÙŠÙ…</button>
        <button id="audioHelpBtn" class="btn-tool btn-audio-help" onclick="playAyaHint()">ğŸ”Š Ø§Ø³Ù…Ø¹ Ø§Ù„Ù‚Ø§Ø±Ø¦</button>
        <button id="hintBtn" class="btn-tool btn-hint" onclick="showFirstWord()">ğŸ”‘ Ù…ÙØªØ§Ø­ Ø§Ù„Ø«Ø¨Ø§Øª</button>
    </div>

    <button id="saveProgressBtn" class="btn btn-save">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù…</button>
</div>

<div class="guide-section">
    <div class="guide-title">ğŸ“œ Ø¯Ù„ÙŠÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ØµØ­Ø­ Ø§Ù„Ø°ÙƒÙŠ:</div>
    
    <div class="guide-item">
        <div class="guide-dot"></div>
        <div><span class="guide-label">Ø§Ø®ØªØ§Ø±ÙˆØ§ Ù„ÙŠ:</span> ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø³ÙˆØ±Ø© ÙˆØ¢ÙŠØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù‚ÙˆØ© Ø­ÙØ¸Ùƒ Ø¨Ø´ÙƒÙ„ Ù…ÙØ§Ø¬Ø¦.</div>
    </div>
    <div class="guide-item">
        <div class="guide-dot"></div>
        <div><span class="guide-label">Ø§Ù„Ø£Ø±Ø¨Ø§Ø¹:</span> Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© ØªØªÙŠØ­ Ù„Ùƒ ØªØ­Ø¯ÙŠØ¯ Ø±Ø¨Ø¹ Ù…Ø¹ÙŠÙ† Ø£Ùˆ Ø­Ø²Ø¨ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ù†Ù‡ Ø¨Ø¯Ù‚Ø©.</div>
    </div>
    <div class="guide-item">
        <div class="guide-dot"></div>
        <div><span class="guide-label">Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­ÙØ¸:</span> Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ù„ÙˆÙ† Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙŠÙˆØ¶Ø­ ØªÙ‚Ø¯Ù…ÙƒØ› Ø§Ù„Ù„ÙˆÙ† <span style="color:#2ecc71; font-weight:bold;">Ø§Ù„Ø£Ø®Ø¶Ø±</span> ÙŠØ¹Ù†ÙŠ Ø§Ø³ØªØ­Ø¶Ø§Ø±Ø§Ù‹ Ø³Ø±ÙŠØ¹Ø§Ù‹ØŒ Ùˆ<span style="color:#e74c3c; font-weight:bold;">Ø§Ù„Ø£Ø­Ù…Ø±</span> ÙŠØ¹Ù†ÙŠ Ø­Ø§Ø¬ØªÙƒ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.</div>
    </div>
    <div class="guide-item">
        <div class="guide-dot"></div>
        <div><span class="guide-label">Ù…ÙØªØ§Ø­ Ø§Ù„Ø«Ø¨Ø§Øª:</span> Ø¥Ø°Ø§ ØªØ¹Ø«Ø±ØªØŒ ÙŠØ¸Ù‡Ø± Ù„Ùƒ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù…Ù† Ø§Ù„Ø¢ÙŠØ© Ù„ØªÙ†Ø´ÙŠØ· Ø°Ø§ÙƒØ±ØªÙƒ Ø¯ÙˆÙ† ÙƒØ´Ù Ø§Ù„Ø¢ÙŠØ© ÙƒØ§Ù…Ù„Ø©.</div>
    </div>
    <div class="guide-item">
        <div class="guide-dot"></div>
        <div><span class="guide-label">Ø¥Ø±Ø´Ø§Ø¯Ø§Øª ÙƒØ±ÙŠÙ…:</span> ÙŠÙˆÙØ± Ù„Ùƒ ØªÙˆØ¬ÙŠÙ‡Ø§Øª ØµÙˆØªÙŠØ© ÙˆÙÙ†ÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø© Ø­ÙˆÙ„ Ù…Ø®Ø§Ø±Ø¬ Ø§Ù„Ø­Ø±ÙˆÙ ÙˆØ§Ù„Ù…Ø¯ÙˆØ¯ ÙˆØ§Ù„Ù„Ø­ÙˆÙ† Ø§Ù„Ø¬Ù„ÙŠØ© ÙˆØ§Ù„Ø®ÙÙŠØ©.</div>
    </div>
    <div class="guide-item">
        <div class="guide-dot"></div>
        <div><span class="guide-label">Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù…:</span> Ù„Ø§ ØªÙ‚Ù„Ù‚ Ù…Ù† Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©ØŒ Ø²Ø± Ø§Ù„Ø­ÙØ¸ ÙŠØ¨Ù‚ÙŠ Ù…ÙƒØ§Ù†Ùƒ Ù…Ø­ÙÙˆØ¸Ø§Ù‹ Ù„ØªØ¹ÙˆØ¯ Ø¥Ù„ÙŠÙ‡ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª.</div>
    </div>
</div>

<div id="quranModal" class="quran-modal">
    <div class="quran-modal-header">
        <h2 id="modalTitle" style="color:var(--main); margin:0; font-size:1.2rem;">Ø§Ù„Ù…ØµØ­Ù Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h2>
        <button class="close-modal" onclick="closeQuranModal()">Ø¥ØºÙ„Ø§Ù‚ âœ•</button>
    </div>
    <div id="quranTextContent" style="font-family: 'Amiri', serif; font-size: 1.5rem; line-height: 2.5; text-align: justify; direction: rtl;"></div>
</div>

<div style="margin-top:20px; text-align:center;">
    <span id="saveStatus" style="color:var(--main); font-weight:bold; font-size:0.75rem;"></span><br>
    <a href="../leader/home.html" style="color: var(--main); text-decoration: none; font-weight: bold; font-size: 0.8rem; border-bottom: 1px solid var(--gold);">ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
</div>

<script>
    function cleanTextForSelect(text) {
        if (!text) return "";
        return text
            .replace(/[\u0610-\u061A\u064B-\u065F\u06D6-\u06DC\u06DF-\u06E8\u06EA-\u06ED]/g, "")
            .replace(/Ù±/g, "Ø§")
            .replace(/Û /g, "")
            .trim();
    }

    const surahNames = ["Ø§Ù„ÙØ§ØªØ­Ø©","Ø§Ù„Ø¨Ù‚Ø±Ø©","Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†","Ø§Ù„Ù†Ø³Ø§Ø¡","Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©","Ø§Ù„Ø£Ù†Ø¹Ø§Ù…","Ø§Ù„Ø£Ø¹Ø±Ø§Ù","Ø§Ù„Ø£Ù†ÙØ§Ù„","Ø§Ù„ØªÙˆØ¨Ø©","ÙŠÙˆÙ†Ø³","Ù‡ÙˆØ¯","ÙŠÙˆØ³Ù","Ø§Ù„Ø±Ø¹Ø¯","Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…","Ø§Ù„Ø­Ø¬Ø±","Ø§Ù„Ù†Ø­Ù„","Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡","Ø§Ù„ÙƒÙ‡Ù","Ù…Ø±ÙŠÙ…","Ø·Ù‡","Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡","Ø§Ù„Ø­Ø¬","Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†","Ø§Ù„Ù†ÙˆØ±","Ø§Ù„ÙØ±Ù‚Ø§Ù†","Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡","Ø§Ù„Ù†Ù…Ù„","Ø§Ù„Ù‚ØµØµ","Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª","Ø§Ù„Ø±ÙˆÙ…","Ù„Ù‚Ù…Ø§Ù†","Ø§Ù„Ø³Ø¬Ø¯Ø©","Ø§Ù„Ø£Ø­Ø²Ø§Ø¨","Ø³Ø¨Ø£","ÙØ§Ø·Ø±","ÙŠØ³","Ø§Ù„ØµØ§ÙØ§Øª","Øµ","Ø§Ù„Ø²Ù…Ø±","ØºØ§ÙØ±","ÙØµÙ„Øª","Ø§Ù„Ø´ÙˆØ±Ù‰","Ø§Ù„Ø²Ø®Ø±Ù","Ø§Ù„Ø¯Ø®Ø§Ù†","Ø§Ù„Ø¬Ø§Ø«ÙŠØ©","Ø§Ù„Ø£Ø­Ù‚Ø§Ù","Ù…Ø­Ù…Ø¯","Ø§Ù„ÙØªØ­","Ø§Ù„Ø­Ø¬Ø±Ø§Øª","Ù‚","Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª","Ø§Ù„Ø·ÙˆØ±","Ø§Ù„Ù†Ø¬Ù…","Ø§Ù„Ù‚Ù…Ø±","Ø§Ù„Ø±Ø­Ù…Ù†","Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©","Ø§Ù„Ø­Ø¯ÙŠØ¯","Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©","Ø§Ù„Ø­Ø´Ø±","Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©","Ø§Ù„ØµÙ","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†","Ø§Ù„ØªØºØ§Ø¨Ù†","Ø§Ù„Ø·Ù„Ø§Ù‚","Ø§Ù„ØªØ­Ø±ÙŠÙ…","Ø§Ù„Ù…Ù„Ùƒ","Ø§Ù„Ù‚Ù„Ù…","Ø§Ù„Ø­Ø§Ù‚Ø©","Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬","Ù†ÙˆØ­","Ø§Ù„Ø¬Ù†","Ø§Ù„Ù…Ø²Ù…Ù„","Ø§Ù„Ù…Ø¯Ø«Ø±","Ø§Ù„Ù‚ÙŠØ§Ù…Ø©","Ø§Ù„Ø¥Ù†Ø³Ø§Ù†","Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª","Ø§Ù„Ù†Ø¨Ø£","Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª","Ø¹Ø¨Ø³","Ø§Ù„ØªÙƒÙˆÙŠØ±","Ø§Ù„Ø§Ù†ÙØ·Ø§Ø±","Ø§Ù„Ù…Ø·ÙÙÙŠÙ†","Ø§Ù„Ø§Ù†Ø´Ù‚Ø§Ù‚","Ø§Ù„Ø¨Ø±ÙˆØ¬","Ø§Ù„Ø·Ø§Ø±Ù‚","Ø§Ù„Ø£Ø¹Ù„Ù‰","Ø§Ù„ØºØ§Ø´ÙŠØ©","Ø§Ù„ÙØ¬Ø±","Ø§Ù„Ø¨Ù„Ø¯","Ø§Ù„Ø´Ù…Ø³","Ø§Ù„Ù„ÙŠÙ„","Ø§Ù„Ø¶Ø­Ù‰","Ø§Ù„Ø´Ø±Ø­","Ø§Ù„ØªÙŠÙ†","Ø§Ù„Ø¹Ù„Ù‚","Ø§Ù„Ù‚Ø¯Ø±","Ø§Ù„Ø¨ÙŠÙ†Ø©","Ø§Ù„Ø²Ù„Ø²Ù„Ø©","Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª","Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©","Ø§Ù„ØªÙƒØ§Ø«Ø±","Ø§Ù„Ø¹ØµØ±","Ø§Ù„Ù‡Ù…Ø²Ø©","Ø§Ù„ÙÙŠÙ„","Ù‚Ø±ÙŠØ´","Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†","Ø§Ù„ÙƒÙˆØ«Ø±","Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†","Ø§Ù„Ù†ØµØ±","Ø§Ù„Ù…Ø³Ø¯","Ø§Ù„Ø¥Ø®Ù„Ø§Øµ","Ø§Ù„ÙÙ„Ù‚","Ø§Ù„Ù†Ø§Ø³"];
    
    const select = document.getElementById('surahSelect');
    const quarterSelect = document.getElementById('quarterSelect');
    
    surahNames.forEach((name, i) => {
        let opt = document.createElement('option');
        opt.value = i + 1;
        opt.innerHTML = (i + 1) + ". " + cleanTextForSelect(name);
        select.appendChild(opt);
    });

    let activeData = [];
    let currentIdx = 0;
    let isRevealed = false;
    let startTime, timerInterval;
    let audioHint = new Audio();
    let currentSurahName = "";

    const ayaText = document.getElementById('ayaText');
    const actionBtn = document.getElementById('actionBtn');
    const timerDisplay = document.getElementById('timer');
    const infoCardBox = document.getElementById('infoCardBox');
    const heatMap = document.getElementById('heatMap');
    const saadiBtn = document.getElementById('saadiBtn');
    const karimBtn = document.getElementById('karimBtn');
    const audioHelpBtn = document.getElementById('audioHelpBtn');
    const hintBtn = document.getElementById('hintBtn');
    const tafseerSaadi = document.getElementById('tafseerSaadi');
    const karimBox = document.getElementById('karimBox');

    select.onchange = async function(e, savedIdx = 0) {
        if(!this.value) { quarterSelect.style.display = 'none'; return; }
        actionBtn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
        try {
            const res = await fetch(`https://api.alquran.cloud/v1/surah/${this.value}`);
            const json = await res.json();
            
            const cleanSName = cleanTextForSelect(json.data.name);
            const cleanSType = json.data.revelationType === 'Meccan' ? 'Ù…ÙƒÙŠØ©' : 'Ù…Ø¯Ù†ÙŠØ©';
            currentSurahName = cleanSName;

            quarterSelect.innerHTML = '<option value="0">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø³ÙˆØ±Ø©</option>';
            let lastQuarter = -1;

            activeData = json.data.ayahs.map((a, index) => {
                const totalQuarters = a.hizbQuarter;
                const hizbNumber = Math.ceil(totalQuarters / 4);
                let quarterInHizb = totalQuarters % 4;
                if(quarterInHizb === 0) quarterInHizb = 4;

                if (totalQuarters !== lastQuarter) {
                    let opt = document.createElement('option');
                    opt.value = index;
                    let rawQuarterTxt = a.text.split(' ').slice(0, 4).join(' ');
                    let cleanedQuarterTxt = cleanTextForSelect(rawQuarterTxt);
                    opt.innerHTML = `Ø§Ù„Ø±Ø¨Ø¹ ${quarterInHizb} (Ø­Ø²Ø¨ ${hizbNumber}): ${cleanedQuarterTxt}...`;
                    quarterSelect.appendChild(opt);
                    lastQuarter = totalQuarters;
                }

                return {
                    full: a.text,
                    number: a.number,
                    meta: `âœ¨ Ø³ÙˆØ±Ø© ${cleanSName} (${cleanSType}) | Ø§Ù„Ø¢ÙŠØ©: ${a.numberInSurah} | Ø§Ù„Ø¬Ø²Ø¡: ${a.juz} <br> Ø§Ù„Ø­Ø²Ø¨: ${hizbNumber} | Ø§Ù„Ø±Ø¨Ø¹: ${quarterInHizb}`
                };
            });

            quarterSelect.style.display = 'block'; 
            currentIdx = (typeof savedIdx === 'number') ? savedIdx : 0;
            
            syncQuarterSelect(currentIdx);
            initHeatMap();
            resetAyaUI();
            updateQuranModalContent(json.data);
        } catch(err) { actionBtn.innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"; }
    };

    quarterSelect.onchange = function() {
        currentIdx = parseInt(this.value);
        initHeatMap();
        resetAyaUI();
    };

    function syncQuarterSelect(idx) {
        let bestMatch = 0;
        for(let i=0; i<quarterSelect.options.length; i++) {
            let val = parseInt(quarterSelect.options[i].value);
            if(val <= idx) bestMatch = i;
        }
        quarterSelect.selectedIndex = bestMatch;
    }

    async function pickRandomAya() {
        actionBtn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±...";
        const randomSurahNum = Math.floor(Math.random() * 114) + 1;
        const res = await fetch(`https://api.alquran.cloud/v1/surah/${randomSurahNum}`);
        const json = await res.json();
        const randomAyaIdx = Math.floor(Math.random() * json.data.ayahs.length);
        select.value = randomSurahNum;
        select.onchange(null, randomAyaIdx);
    }

    function initHeatMap() {
        heatMap.innerHTML = '';
        activeData.forEach((_, idx) => {
            const unit = document.createElement('div');
            unit.className = 'heat-unit';
            if(idx < currentIdx) unit.style.background = '#ccc';
            heatMap.appendChild(unit);
        });
    }

    function resetAyaUI() {
        isRevealed = false;
        ayaText.style.opacity = "0";
        ayaText.classList.add('is-hidden');
        infoCardBox.style.display = 'none';
        tafseerSaadi.style.display = 'none';
        karimBox.style.display = 'none';
        
        saadiBtn.style.opacity = "0.5";
        karimBtn.style.opacity = "0.5";
        audioHelpBtn.style.opacity = "1";
        hintBtn.style.opacity = "1";
        
        ayaText.innerText = activeData[currentIdx] ? activeData[currentIdx].full : "";
        actionBtn.innerText = "Ø§ÙƒØ´Ù Ø§Ù„Ø¢ÙŠØ©";
        stopTimer();
        timerDisplay.innerText = "0.0";
    }

    function showFirstWord() {
        if(!activeData[currentIdx] || isRevealed) return;
        let currentFullText = activeData[currentIdx].full.trim();
        if (currentIdx === 0 && select.value != 1 && select.value != 9) {
            currentFullText = currentFullText.replace("Ø¨Ø§Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ… ", "");
        }
        const words = currentFullText.split(/\s+/);
        let hintText = "";
        if (words.length > 0) {
            if (words[0] === "Ø¨Ø§Ø³Ù…") hintText = words.slice(0, 4).join(' ');
            else hintText = words.slice(0, 2).join(' ');
        }
        document.getElementById('hintWordContent').innerText = hintText + " ...";
        document.getElementById('hintOverlay').style.display = 'flex';
    }

    function closeHint() { document.getElementById('hintOverlay').style.display = 'none'; }

    function playAyaHint() {
        if (!activeData[currentIdx] || isRevealed) return;
        audioHelpBtn.innerText = "â³ Ø¬Ø§Ø±ÙŠ...";
        audioHint.src = `https://cdn.islamic.network/quran/audio/128/ar.alafasy/${activeData[currentIdx].number}.mp3`;
        audioHint.play();
        audioHint.onplaying = () => {
            audioHelpBtn.innerText = "ğŸµ ÙŠØ¹Ù…Ù„...";
            setTimeout(() => { audioHint.pause(); audioHelpBtn.innerText = "ğŸ”Š Ø§Ø³Ù…Ø¹ Ø§Ù„Ù‚Ø§Ø±Ø¦"; }, 3000);
        };
    }

    function startTimer() {
        startTime = Date.now();
        timerInterval = setInterval(() => {
            timerDisplay.innerText = ((Date.now() - startTime) / 1000).toFixed(1);
        }, 100);
    }

    function stopTimer() { clearInterval(timerInterval); timerInterval = null; }

    actionBtn.onclick = function() {
        if(!isRevealed) {
            if(!timerInterval) startTimer();
            reveal();
        } else {
            prepareNext();
        }
    };

    function reveal() {
        const time = parseFloat(timerDisplay.innerText);
        stopTimer();
        isRevealed = true;
        ayaText.style.opacity = "1";
        ayaText.classList.remove('is-hidden');
        actionBtn.innerText = "Ø§Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ©";
        
        saadiBtn.style.opacity = "1";
        karimBtn.style.opacity = "1";
        audioHelpBtn.style.opacity = "0.5";
        hintBtn.style.opacity = "0.5";

        infoCardBox.innerHTML = activeData[currentIdx].meta;
        infoCardBox.style.display = 'block';
        const units = document.querySelectorAll('.heat-unit');
        if(units[currentIdx]) {
            if(time <= 3.5) units[currentIdx].style.background = '#2ecc71';
            else if(time <= 8) units[currentIdx].style.background = '#f1c40f';
            else units[currentIdx].style.background = '#e74c3c';
        }
    }

    async function getSaadiTafseer() {
        if(!isRevealed) return;
        if (tafseerSaadi.style.display === 'block') { tafseerSaadi.style.display = 'none'; return; }
        tafseerSaadi.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨...";
        tafseerSaadi.style.display = 'block';
        try {
            const res = await fetch(`https://api.alquran.cloud/v1/ayah/${select.value}:${currentIdx + 1}/ar.muyassar`);
            const json = await res.json();
            tafseerSaadi.innerHTML = `<b>ğŸ“– Ø§Ù„ØªÙØ³ÙŠØ± Ø§Ù„Ù…ÙŠØ³Ø±:</b><br>${json.data.text}`;
        } catch(e) { tafseerSaadi.innerHTML = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„."; }
    }

    function getKarimGuidance() {
        if(!isRevealed) return;
        if (karimBox.style.display === 'block') { karimBox.style.display = 'none'; return; }
        karimBox.style.display = 'block';
        const text = activeData[currentIdx].full;
        let guidance = `<div style="border-bottom:2px solid var(--blue); padding-bottom:5px; margin-bottom:10px; font-weight:900;">ğŸ™ï¸ Ø¥Ø±Ø´Ø§Ø¯Ø§Øª ÙƒØ±ÙŠÙ… Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© Ù„ØªØµØ­ÙŠØ­ Ø§Ù„ØªÙ„Ø§ÙˆØ©:</div>`;
        guidance += `<p>ğŸ”¹ <b>Ø£ÙˆÙ„Ø§: Ù…ÙˆØ§Ø²ÙŠÙ† Ø§Ù„Ù…Ø¯ÙˆØ¯ ÙˆÙ‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªÙ‚Ø§Ù…Ø©:</b><br>ÙŠØ¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø­Ø°Ù‚ Ø£Ù† ÙŠØ²Ù† Ø§Ù„Ù…Ø¯ÙˆØ¯ Ø¨Ù…ÙŠØ²Ø§Ù† Ø¯Ù‚ÙŠÙ‚ØŒ ÙÙ„Ø§ ÙŠØ·ØºÙ‰ Ù…Ø¯ Ø¹Ù„Ù‰ Ø¢Ø®Ø±. Ø§Ø­Ø±Øµ Ø¹Ù„Ù‰ ØªØ³ÙˆÙŠØ© Ø§Ù„Ù…Ø¯ÙˆØ¯ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© Ø¨Ù…Ù‚Ø¯Ø§Ø± Ø­Ø±ÙƒØªÙŠÙ†ØŒ ÙˆØ§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù…Ø¯ Ø§Ù„Ù…ØªØµÙ„ ÙˆØ§Ù„Ù…Ù†ÙØµÙ„ Ø­Ø³Ø¨ Ø§Ù„Ø±ÙˆØ§ÙŠØ©ØŒ Ù…Ø¹ ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙ…Ø·ÙŠØ· Ø£Ùˆ Ø§Ù„Ø¨ØªØ± Ø§Ù„Ø°ÙŠ ÙŠØ°Ù‡Ø¨ Ø¨Ø±ÙˆÙ†Ù‚ Ø§Ù„Ø¢ÙŠØ© ÙˆÙŠØ®Ù„ Ø¨Ù…ÙˆØ³ÙŠÙ‚Ø§Ù‡Ø§ Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠØ©.</p>`;
        if (text.includes('Ù†') || text.includes('Ù…')) {
            guidance += `<p>ğŸ”¹ <b>Ø«Ø§Ù†ÙŠØ§: Ø£Ø­ÙƒØ§Ù… Ø§Ù„ØºÙ†Ø© ÙˆØªØ­Ù‚ÙŠÙ‚ Ø§Ù„ØµÙØ§Øª:</b><br>Ø¹Ù†Ø¯ ÙˆØ±ÙˆØ¯ Ø§Ù„Ù†ÙˆÙ† Ø£Ùˆ Ø§Ù„Ù…ÙŠÙ… Ø§Ù„Ù…Ø´Ø¯Ø¯ØªÙŠÙ†ØŒ Ø£Ùˆ Ø£Ø­ÙƒØ§Ù… Ø§Ù„Ø¥Ø®ÙØ§Ø¡ ÙˆØ§Ù„Ø¥Ø¯ØºØ§Ù…ØŒ ÙŠØ¬Ø¨ ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„ØºÙ†Ø© ÙƒØ§Ù…Ù„Ø© Ù…Ù† Ø§Ù„Ø®ÙŠØ´ÙˆÙ… Ø¨Ù…Ù‚Ø¯Ø§Ø± Ø­Ø±ÙƒØªÙŠÙ†. Ø§Ù„ØºÙ†Ø© Ù‡ÙŠ Ø±ÙˆØ­ Ø§Ù„Ø­Ø±Ù ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙˆØ§Ø¶Ø¹ØŒ ÙˆØ¨Ø¯ÙˆÙ†Ù‡Ø§ ØªØµØ¨Ø­ Ø§Ù„ØªÙ„Ø§ÙˆØ© Ø¬Ø§ÙØ© ÙØ§Ù‚Ø¯Ø© Ù„Ù„Ø¬Ù…Ø§Ù„ ÙˆØ§Ù„Ø¶Ø¨Ø·.</p>`;
        }
        guidance += `<p>ğŸ”¹ <b>Ø«Ø§Ù„Ø«Ø§: Ù…Ø®Ø§Ø±Ø¬ Ø§Ù„Ø­Ø±ÙˆÙ ÙˆØªØ­Ø±ÙŠØ±Ù‡Ø§:</b><br>Ø§Ù„Ù‚Ø±Ø¢Ù† Ù†Ø²Ù„ Ø¨Ù„Ø³Ø§Ù† Ø¹Ø±Ø¨ÙŠ Ù…Ø¨ÙŠÙ†ØŒ Ù„Ø°Ø§ ÙˆØ¬Ø¨ Ø¥Ø¹Ø·Ø§Ø¡ ÙƒÙ„ Ø­Ø±Ù Ø­Ù‚Ù‡ ÙˆÙ…Ø³ØªØ­Ù‚Ù‡ Ù…Ù† Ø§Ù„Ù…Ø®Ø±Ø¬ ÙˆØ§Ù„ØµÙØ©. Ø§Ù†ØªØ¨Ù‡ Ù„ØªÙØ®ÙŠÙ… Ø§Ù„Ù…Ø±ÙÙ‚ Ø£Ùˆ ØªØ±Ù‚ÙŠÙ‚ Ø§Ù„Ù…ÙØ®Ù…ØŒ Ø®Ø§ØµØ© Ø¹Ù†Ø¯ Ø¬Ø§ÙˆØ±Ø© Ø§Ù„Ø­Ø±ÙˆÙ Ù„Ø¨Ø¹Ø¶Ù‡Ø§ØŒ Ù„ØªØ¬Ù†Ø¨ Ø®Ù„Ø· Ø§Ù„Ø£ØµÙˆØ§Øª ÙˆØ¶ÙŠØ§Ø¹ Ù…Ø¹Ø§Ù„Ù… Ø§Ù„ÙƒÙ„Ù…Ø©.</p>`;
        guidance += `<p>ğŸ”¹ <b>Ø±Ø§Ø¨Ø¹Ø§: Ø§Ù„ÙŠÙ‚Ø¸Ø© Ø§Ù„Ø¥Ø¹Ø±Ø§Ø¨ÙŠØ© ÙˆØ§Ù„Ø­Ø°Ø± Ù…Ù† Ø§Ù„Ù„Ø­Ù† Ø§Ù„Ø¬Ù„ÙŠ:</b><br>Ø¥Ù† Ø§Ù„Ø®Ø·Ø£ ÙÙŠ Ø­Ø±ÙƒØ© ÙˆØ§Ø­Ø¯Ø© (ÙØªØ­Ø©ØŒ Ø¶Ù…Ø©ØŒ ÙƒØ³Ø±Ø©) Ù‚Ø¯ ÙŠÙ‚Ù„Ø¨ Ø§Ù„Ù…Ø¹Ù†Ù‰ Ø±Ø£Ø³Ø§ Ø¹Ù„Ù‰ Ø¹Ù‚Ø¨. Ø±Ø§Ù‚Ø¨ Ø£ÙˆØ§Ø®Ø± Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙˆØ­Ø±ÙƒØ§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡ ÙˆØ§Ù„Ø¥Ø¹Ø±Ø§Ø¨ Ø¨ÙŠÙ‚Ø¸Ø© ØªØ§Ù…Ø©ØŒ ÙØ§Ù„Ù…ØµÙ„ÙŠ Ø®Ù„ÙÙƒ ÙˆØ§Ù„Ø­Ø§ÙØ¸ Ù…Ø¹Ùƒ ÙŠØ£ØªÙ…Ø±Ø§Ù† Ø¨ØµØ­Ø© Ù‚Ø±Ø§Ø¡ØªÙƒ.</p>`;
        guidance += `<p style="background:rgba(52, 152, 219, 0.1); padding:10px; border-radius:10px;">âš ï¸ <b>Ø®Ø§ØªÙ…Ø© ÙˆØªÙ†Ø¨ÙŠÙ‡:</b> Ø§Ø¹Ù„Ù… ÙŠØ§ Ø±Ø¹Ø§Ùƒ Ø§Ù„Ù„Ù‡ Ø£Ù† Ø§Ù„Ø¹Ù„Ù… Ø¨Ø§Ù„Ù‚Ø±Ø¢Ù† ØªÙ„Ù‚ ÙˆÙ„ÙŠØ³ Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·. Ø§Ù„Ø²Ù… Ø¯Ø§Ø¦Ù…Ø§ Ø§Ù„Ø¬Ù„ÙˆØ³ Ø¨ÙŠÙ† ÙŠØ¯ÙŠ Ø§Ù„Ù…Ø´Ø§ÙŠØ® Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ† ÙˆØ§Ù„Ù…Ø¬ÙˆØ¯ÙŠÙ†ØŒ ÙØ§Ù„Ø£Ø°Ù† ØªØµØ­Ø­ Ù…Ø§ ÙŠØ¹Ø¬Ø² Ø§Ù„Ù„Ø³Ø§Ù† Ø¹Ù† Ø¶Ø¨Ø·Ù‡ Ù…Ù† ØªÙ„Ù‚Ø§Ø¡ Ù†ÙØ³Ù‡.</p>`;
        karimBox.innerHTML = guidance;
    }

    function prepareNext() {
        if (currentIdx < activeData.length - 1) {
            currentIdx++;
            resetAyaUI();
            syncQuarterSelect(currentIdx);
            startTimer();
        } else { alert("ØªÙ…Øª Ø§Ù„Ø³ÙˆØ±Ø© Ø¨Ø­Ù…Ø¯ Ø§Ù„Ù„Ù‡"); }
    }

    function updateQuranModalContent(data) {
        let html = `<div style="text-align:center; color:var(--gold); margin-bottom:20px;">Ø¨Ø§Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…</div>`;
        data.ayahs.forEach(a => {
            let t = a.text;
            if (a.numberInSurah === 1 && data.number !== 1 && data.number !== 9) t = t.replace("Ø¨Ø§Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ… ", "");
            html += `${t} <span style="color:var(--gold);">ï´¿${a.numberInSurah}ï´¾</span> `;
        });
        document.getElementById('quranTextContent').innerHTML = html;
        document.getElementById('modalTitle').innerText = "Ø³ÙˆØ±Ø© " + cleanTextForSelect(data.name);
    }

    function openQuranModal() { document.getElementById('quranModal').style.display = 'flex'; }
    function closeQuranModal() { document.getElementById('quranModal').style.display = 'none'; }

    document.getElementById('saveProgressBtn').onclick = function() {
        localStorage.setItem('quran_save', JSON.stringify({ surah: select.value, pos: currentIdx }));
        document.getElementById('saveStatus').innerText = "âœ… ØªÙ… Ø­ÙØ¸ Ù…ÙƒØ§Ù†Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ù†Ø¬Ø§Ø­";
        setTimeout(() => document.getElementById('saveStatus').innerText = "", 3000);
    };

    window.onload = function() {
        const saved = localStorage.getItem('quran_save');
        if (saved) {
            const d = JSON.parse(saved);
            select.value = d.surah;
            select.onchange(null, d.pos);
        }
    };
</script>
</body>
</html>
