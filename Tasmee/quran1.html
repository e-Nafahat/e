<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…ÙØµÙØ­Ù‘ÙØ­Ù Ù†ÙÙÙØ­ÙØ§ØªÙ | Ø§Ù„ÙØ§Ø®Ù’ØªÙØ¨ÙØ§Ø±Ù Ø§Ù„Ø´Ù‘ÙØ§Ù…ÙÙ„Ù</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --main: #2ecc71; 
            --gold: #d4af37; 
            --bg: #0a192f; 
            --card: #112240; 
            --red: #e74c3c; 
            --blue: #3498db;
            --purple: #9b59b6;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); color: white; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }

        .header { text-align: center; margin-bottom: 15px; }
        .header img { width: 55px; filter: drop-shadow(0 0 5px var(--gold)); }
        .header h1 { color: var(--gold); font-size: 1.1rem; margin-top: 5px; }

        /* Ø­Ø§ÙˆÙŠØ© Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
        .top-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 450px;
            margin-bottom: 15px;
        }

        .surah-selector { 
            flex: 2;
            background: rgba(52, 152, 219, 0.1); 
            color: var(--blue); border: 2px solid var(--blue); 
            padding: 8px 10px; border-radius: 12px; 
            font-weight: 700 !important; font-size: 0.85rem;
            text-align: center; cursor: pointer;
            appearance: none; -webkit-appearance: none;
            transition: 0.3s;
        }
        
        .surah-selector option { background: var(--card); color: white; }

        .btn-view-quran-small { 
            flex: 1;
            background: rgba(212, 175, 55, 0.1); 
            color: var(--gold); border: 2px solid var(--gold);
            padding: 8px 10px; border-radius: 12px;
            font-weight: 700; font-size: 0.85rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            gap: 5px; transition: 0.3s;
        }
        .btn-view-quran-small:active { transform: scale(0.95); background: var(--gold); color: #000; }

        .heat-map { display: flex; width: 100%; max-width: 450px; height: 6px; background: #222; border-radius: 3px; margin-bottom: 15px; overflow: hidden; }
        .heat-unit { flex: 1; border-right: 1px solid #000; transition: 0.5s; background: #333; }

        .quran-card {
            width: 100%; max-width: 450px; background: var(--card); border-radius: 25px;
            padding: 25px; border: 1px solid rgba(212, 175, 55, 0.2); position: relative;
            box-shadow: 0 15px 40px rgba(0,0,0,0.5); border-bottom: 6px solid #0a1221;
        }

        .aya-display {
            font-family: 'Amiri', serif;
            font-size: 1.35rem; line-height: 2; min-height: 100px;
            display: flex; align-items: center; justify-content: center;
            text-align: center; margin-bottom: 20px; transition: 0.01s;
            color: var(--main); font-weight: 700;
        }
        .is-hidden { opacity: 0 !important; }

        .info-card-box { display: none; background: rgba(0,0,0,0.4); border: 1px solid var(--gold); border-radius: 12px; padding: 10px; margin-bottom: 15px; font-size: 0.75rem; color: #eee; text-align: center; line-height: 1.5; }

        .tafseer-box { display: none; background: rgba(0,0,0,0.6); border: 1px solid var(--main); border-radius: 15px; padding: 15px; margin-bottom: 15px; font-size: 0.9rem; line-height: 1.6; color: #fff; text-align: justify; border-bottom: 4px solid var(--main); }
        
        .karim-box { display: none; background: rgba(52, 152, 219, 0.1); border: 1px solid var(--blue); border-radius: 15px; padding: 15px; margin-bottom: 15px; font-size: 0.85rem; line-height: 1.6; color: #fff; text-align: right; border-right: 5px solid var(--blue); }

        .timer-box { font-size: 0.8rem; color: #666; margin-bottom: 10px; text-align: center; }

        .btn { width: 100%; padding: 16px; border: none; border-radius: 15px; font-weight: 900; font-size: 1rem; cursor: pointer; position: relative; transition: 0.1s; }
        .btn-main { background: var(--main); color: #000; box-shadow: 0 5px #1e8449; }
        .btn-main:active { top: 3px; box-shadow: 0 2px #1e8449; }
        .btn-main:disabled { background: #555; box-shadow: none; color: #888; cursor: not-allowed; }
        
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .btn-tool { padding: 10px; border-radius: 12px; border: none; font-weight: bold; font-size: 0.8rem; cursor: pointer; display: none; color: white; transition: 0.2s; }
        .btn-saadi { background: #16a085; border-bottom: 3px solid #0e6655; }
        .btn-karim { background: var(--blue); border-bottom: 3px solid #2471a3; }
        .btn-tool:active { transform: translateY(2px); border-bottom: 1px solid transparent; }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø·ÙˆØ± */
        .help-section { margin-top: 10px; text-align: center; }
        .btn-help-trigger { background: var(--purple); color: white; border-radius: 15px; padding: 12px; font-weight: bold; border: none; width: 100%; cursor: pointer; box-shadow: 0 4px #7d3c98; }
        .btn-help-trigger:active { transform: translateY(2px); box-shadow: 0 2px #7d3c98; }
        .help-input-area { display: none; margin-top: 10px; background: rgba(155, 89, 182, 0.1); padding: 10px; border-radius: 15px; border: 1px solid var(--purple); }
        .help-input-area input { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid var(--purple); background: var(--bg); color: white; text-align: center; margin-top: 5px; }

        .btn-save { background: #333; color: white; padding: 12px; font-size: 0.8rem; border-radius: 12px; margin-top: 15px; width: 100%; border: 1px solid #444; cursor: pointer; }

        .quran-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 1000; flex-direction: column; overflow-y: auto; padding: 20px; }
        .quran-modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--gold); padding-bottom: 10px; margin-bottom: 20px; }
        .quran-modal-content { font-family: 'Amiri', serif; font-size: 1.5rem; line-height: 2.5; text-align: justify; color: #f9f9f9; padding: 10px; direction: rtl; }
        .close-modal { background: var(--red); color: white; border: none; border-radius: 10px; padding: 8px 15px; font-weight: bold; cursor: pointer; }

        .nav-tools { width: 100%; max-width: 450px; margin-top: 20px; text-align: center; }
        .nav-link { color: var(--gold); text-decoration: none; font-weight: bold; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="header">
    <img src="../leader/LogoNafahat.png" alt="Logo">
    <h1>Ù…ÙØµÙØ­Ù‘ÙØ­Ù Ø§Ù„Ù†Ù‘ÙÙÙØ­ÙØ§ØªÙ Ø§Ù„Ø´Ù‘ÙØ§Ù…ÙÙ„Ù</h1>
</div>

<div class="top-controls">
    <select id="surahSelect" class="surah-selector">
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø©...</option>
    </select>
    
    <button class="btn-view-quran-small" onclick="openQuranModal()">
        ğŸ“– Ø§Ù„ØµÙ‘ÙØ­ÙÙÙ
    </button>
</div>

<div class="heat-map" id="heatMap"></div>

<div class="quran-card">
    <div class="timer-box">Ø²ÙÙ…ÙÙ†Ù Ø§Ù„ÙØ§Ø³Ù’ØªÙØ­Ù’Ø¶ÙØ§Ø±Ù: <span id="timer">0.0</span> Ø«Ø§Ù†ÙŠØ©</div>
    
    <div id="infoCardBox" class="info-card-box"></div>
    
    <div id="tafseerSaadi" class="tafseer-box"></div>
    <div id="karimBox" class="karim-box"></div>

    <div id="ayaText" class="aya-display is-hidden">Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„Ù‘ÙÙ‡Ù Ø§Ù„Ø±Ù‘ÙØ­Ù’Ù…ÙÙ†Ù Ø§Ù„Ø±Ù‘ÙØ­ÙÙŠÙ…Ù</div>
    
    <div class="action-grid">
        <button id="saadiBtn" class="btn-tool btn-saadi" onclick="getSaadiTafseer()">ğŸ“– Ø§Ù„ØªÙØ³ÙŠØ± Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ</button>
        <button id="karimBtn" class="btn-tool btn-karim" onclick="getKarimGuidance()">ğŸ™ï¸ Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ„Ø§ÙˆØ©</button>
    </div>

    <button id="actionBtn" class="btn btn-main">Ø§ÙÙƒÙ’Ø´ÙÙÙ Ø§Ù„Ù’Ø¢ÙŠÙØ©Ù</button>
    
    <div class="help-section" id="helpSection" style="display:none;">
        <button id="helpBtn" class="btn-help-trigger" onclick="requestAyaHelp()">ğŸ’¡ Ø·Ù„Ø¨ Ù…Ø³Ø§Ø¹Ø¯Ø© (4)</button>
        <div id="helpInputArea" class="help-input-area">
            <small style="color:var(--purple)">Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„ØªØ³ØªØ·ÙŠØ¹ Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„:</small>
            <input type="text" id="helpWordInput" placeholder="..." oninput="validateHelpWord(this.value)">
        </div>
    </div>
    
    <button id="saveProgressBtn" class="btn btn-save">ğŸ’¾ Ø­ÙÙÙ’Ø¸Ù Ø§Ù„ØªÙ‘ÙÙ‚ÙØ¯Ù‘ÙÙ…Ù ÙˆÙØ§Ù„ØªÙ‘ÙÙˆÙÙ‚Ù‘ÙÙÙ Ø¹ÙÙ†Ù’Ø¯Ù Ù‡ÙØ°ÙÙ‡Ù Ø§Ù„Ù’Ø¢ÙŠÙØ©Ù</button>
</div>

<div id="quranModal" class="quran-modal">
    <div class="quran-modal-header">
        <h2 id="modalTitle" style="color:var(--gold); margin:0; font-size:1.2rem;">Ø§Ù„Ù…ØµØ­Ù Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h2>
        <button class="close-modal" onclick="closeQuranModal()">Ø¥ØºÙ„Ø§Ù‚ âœ•</button>
    </div>
    <div id="quranTextContent" class="quran-modal-content">
        ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø³ÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ù‡Ù†Ø§...
    </div>
</div>

<div class="nav-tools">
    <span id="saveStatus" style="color:var(--gold); font-weight:bold; font-size: 0.75rem;"></span><br>
    <a href="../leader/home.html" class="nav-link">ğŸ  Ø§Ù„Ù’Ø¹ÙÙˆÙ’Ø¯ÙØ©Ù Ù„ÙÙ„ØµÙ‘ÙÙÙ’Ø­ÙØ©Ù Ø§Ù„Ø±Ù‘ÙØ¦ÙÙŠØ³ÙÙŠÙ‘ÙØ©Ù</a>
</div>

<script>
    const surahNames = ["Ø§Ù„ÙØ§ØªØ­Ø©","Ø§Ù„Ø¨Ù‚Ø±Ø©","Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†","Ø§Ù„Ù†Ø³Ø§Ø¡","Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©","Ø§Ù„Ø£Ù†Ø¹Ø§Ù…","Ø§Ù„Ø£Ø¹Ø±Ø§Ù","Ø§Ù„Ø£Ù†ÙØ§Ù„","Ø§Ù„ØªÙˆØ¨Ø©","ÙŠÙˆÙ†Ø³","Ù‡ÙˆØ¯","ÙŠÙˆØ³Ù","Ø§Ù„Ø±Ø¹Ø¯","Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…","Ø§Ù„Ø­Ø¬Ø±","Ø§Ù„Ù†Ø­Ù„","Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡","Ø§Ù„ÙƒÙ‡Ù","Ù…Ø±ÙŠÙ…","Ø·Ù‡","Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡","Ø§Ù„Ø­Ø¬","Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†","Ø§Ù„Ù†ÙˆØ±","Ø§Ù„ÙØ±Ù‚Ø§Ù†","Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡","Ø§Ù„Ù†Ù…Ù„","Ø§Ù„Ù‚ØµØµ","Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª","Ø§Ù„Ø±ÙˆÙ…","Ù„Ù‚Ù…Ø§Ù†","Ø§Ù„Ø³Ø¬Ø¯Ø©","Ø§Ù„Ø£Ø­Ø²Ø§Ø¨","Ø³Ø¨Ø£","ÙØ§Ø·Ø±","ÙŠØ³","Ø§Ù„ØµØ§ÙØ§Øª","Øµ","Ø§Ù„Ø²Ù…Ø±","ØºØ§ÙØ±","ÙØµÙ„Øª","Ø§Ù„Ø´ÙˆØ±Ù‰","Ø§Ù„Ø²Ø®Ø±Ù","Ø§Ù„Ø¯Ø®Ø§Ù†","Ø§Ù„Ø¬Ø§Ø«ÙŠØ©","Ø§Ù„Ø£Ø­Ù‚Ø§Ù","Ù…Ø­Ù…Ø¯","Ø§Ù„ÙØªØ­","Ø§Ù„Ø­Ø¬Ø±Ø§Øª","Ù‚","Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª","Ø§Ù„Ø·ÙˆØ±","Ø§Ù„Ù†Ø¬Ù…","Ø§Ù„Ù‚Ù…Ø±","Ø§Ù„Ø±Ø­Ù…Ù†","Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©","Ø§Ù„Ø­Ø¯ÙŠØ¯","Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©","Ø§Ù„Ø­Ø´Ø±","Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©","Ø§Ù„ØµÙ","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†","Ø§Ù„ØªØºØ§Ø¨Ù†","Ø§Ù„Ø·Ù„Ø§Ù‚","Ø§Ù„ØªØ­Ø±ÙŠÙ…","Ø§Ù„Ù…Ù„Ùƒ","Ø§Ù„Ù‚Ù„Ù…","Ø§Ù„Ø­Ø§Ù‚Ø©","Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬","Ù†ÙˆØ­","Ø§Ù„Ø¬Ù†","Ø§Ù„Ù…Ø²Ù…Ù„","Ø§Ù„Ù…Ø¯Ø«Ø±","Ø§Ù„Ù‚ÙŠØ§Ù…Ø©","Ø§Ù„Ø¥Ù†Ø³Ø§Ù†","Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª","Ø§Ù„Ù†Ø¨Ø£","Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª","Ø¹Ø¨Ø³","Ø§Ù„ØªÙƒÙˆÙŠØ±","Ø§Ù„Ø§Ù†ÙØ·Ø§Ø±","Ø§Ù„Ù…Ø·ÙÙÙŠÙ†","Ø§Ù„Ø§Ù†Ø´Ù‚Ø§Ù‚","Ø§Ù„Ø¨Ø±ÙˆØ¬","Ø§Ù„Ø·Ø§Ø±Ù‚","Ø§Ù„Ø£Ø¹Ù„Ù‰","Ø§Ù„ØºØ§Ø´ÙŠØ©","Ø§Ù„ÙØ¬Ø±","Ø§Ù„Ø¨Ù„Ø¯","Ø§Ù„Ø®Ù…Ø³","Ø§Ù„Ù„ÙŠÙ„","Ø§Ù„Ø¶Ø­Ù‰","Ø§Ù„Ø´Ø±Ø­","Ø§Ù„ØªÙŠÙ†","Ø§Ù„Ø¹Ù„Ù‚","Ø§Ù„Ù‚Ø¯Ø±","Ø§Ù„Ø¨ÙŠÙ†Ø©","Ø§Ù„Ø²Ù„Ø²Ù„Ø©","Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª","Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©","Ø§Ù„ØªÙƒØ§Ø«Ø±","Ø§Ù„Ø¹ØµØ±","Ø§Ù„Ù‡Ù…Ø²Ø©","Ø§Ù„ÙÙŠÙ„","Ù‚Ø±ÙŠØ´","Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†","Ø§Ù„ÙƒÙˆØ«Ø±","Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†","Ø§Ù„Ù†ØµØ±","Ø§Ù„Ù…Ø³Ø¯","Ø§Ù„Ø¥Ø®Ù„Ø§Øµ","Ø§Ù„ÙÙ„Ù‚","Ø§Ù„Ù†Ø§Ø³"];
    const select = document.getElementById('surahSelect');
    surahNames.forEach((name, i) => {
        let opt = document.createElement('option');
        opt.value = i + 1;
        opt.innerHTML = (i + 1) + ". " + name;
        select.appendChild(opt);
    });

    let activeData = [{ full: "Ø§Ø®ØªØ± Ø³ÙˆØ±Ø© Ù„Ù„Ø¨Ø¯Ø¡", meta: "" }];
    let currentIdx = 0;
    let isRevealed = false;
    let startTime, timerInterval;
    let helpCount = 4;
    let isHelpActive = false;

    const ayaText = document.getElementById('ayaText');
    const actionBtn = document.getElementById('actionBtn');
    const timerDisplay = document.getElementById('timer');
    const infoCardBox = document.getElementById('infoCardBox');
    const heatMap = document.getElementById('heatMap');
    const saadiBtn = document.getElementById('saadiBtn');
    const karimBtn = document.getElementById('karimBtn');
    const tafseerSaadi = document.getElementById('tafseerSaadi');
    const karimBox = document.getElementById('karimBox');
    const helpSection = document.getElementById('helpSection');
    const helpBtn = document.getElementById('helpBtn');
    const helpInputArea = document.getElementById('helpInputArea');
    const helpWordInput = document.getElementById('helpWordInput');

    select.onchange = async function(e, savedIdx = 0) {
        if(!this.value) return;
        actionBtn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
        try {
            const res = await fetch(`https://api.alquran.cloud/v1/surah/${this.value}`);
            const json = await res.json();
            const revelationType = json.data.revelationType === 'Meccan' ? 'Ù…ÙƒÙŠØ©' : 'Ù…Ø¯Ù†ÙŠØ©';

            activeData = json.data.ayahs.map(a => ({
                full: a.text,
                meta: `âœ¨ Ø³ÙˆØ±Ø© ${revelationType} | Ø§Ù„Ø¢ÙŠØ©: ${a.numberInSurah} | Ø§Ù„Ø¬Ø²Ø¡: ${a.juz} | Ø§Ù„Ø­Ø²Ø¨: ${a.hizbQuarter}`
            }));
            
            currentIdx = savedIdx;
            helpCount = 4;
            initHeatMap();
            resetAyaUI();
            updateQuranModalContent(json.data);
        } catch(err) {
            actionBtn.innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„";
        }
    };

    function updateQuranModalContent(data) {
        const content = document.getElementById('quranTextContent');
        document.getElementById('modalTitle').innerText = "Ø³ÙˆØ±Ø© " + data.name;
        let fullHtml = `<div style="text-align:center; color:var(--gold); margin-bottom:20px;">Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„Ù‘ÙÙ‡Ù Ø§Ù„Ø±Ù‘ÙØ­Ù’Ù…ÙÙ†Ù Ø§Ù„Ø±Ù‘ÙØ­ÙÙŠÙ…Ù</div>`;
        data.ayahs.forEach(aya => {
            let text = aya.text;
            if (aya.numberInSurah === 1 && data.number !== 1 && data.number !== 9) {
                text = text.replace("Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„Ù‘ÙÙ‡Ù Ø§Ù„Ø±Ù‘ÙØ­Ù’Ù…ÙÙ†Ù Ø§Ù„Ø±Ù‘ÙØ­ÙÙŠÙ…Ù ", "");
            }
            fullHtml += `${text} <span style="color:var(--gold); font-family:sans-serif; font-size:1.1rem;">ï´¿${aya.numberInSurah}ï´¾</span> `;
        });
        content.innerHTML = fullHtml;
    }

    function openQuranModal() {
        if(!select.value) { alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø³ÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹"); return; }
        document.getElementById('quranModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeQuranModal() {
        document.getElementById('quranModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function initHeatMap() {
        heatMap.innerHTML = '';
        activeData.forEach((_, idx) => {
            const unit = document.createElement('div');
            unit.className = 'heat-unit';
            if(idx < currentIdx) unit.style.background = '#444';
            heatMap.appendChild(unit);
        });
    }

    function resetAyaUI() {
        isRevealed = false;
        isHelpActive = false;
        ayaText.style.opacity = "0";
        ayaText.classList.add('is-hidden');
        
        infoCardBox.style.display = 'none';
        tafseerSaadi.style.display = 'none';
        karimBox.style.display = 'none';
        saadiBtn.style.display = 'none';
        karimBtn.style.display = 'none';
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
        helpSection.style.display = select.value ? 'block' : 'none';
        helpInputArea.style.display = 'none';
        helpWordInput.value = "";
        helpBtn.innerText = `ğŸ’¡ Ø·Ù„Ø¨ Ù…Ø³Ø§Ø¹Ø¯Ø© (${helpCount})`;
        helpBtn.disabled = helpCount <= 0;
        actionBtn.disabled = false;

        ayaText.innerText = activeData[currentIdx].full;
        actionBtn.innerText = "Ø§ÙÙƒÙ’Ø´ÙÙÙ Ø§Ù„Ù’Ø¢ÙŠÙØ©Ù";
        stopTimer();
        timerDisplay.innerText = "0.0";
    }

    // Ø¯Ø§Ù„Ø© Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©
    function requestAyaHelp() {
        if(helpCount <= 0 || isRevealed) return;
        
        const words = activeData[currentIdx].full.trim().split(/\s+/);
        ayaText.innerText = words[0] + " ...";
        ayaText.style.opacity = "1";
        ayaText.classList.remove('is-hidden');
        
        isHelpActive = true;
        helpInputArea.style.display = 'block';
        helpBtn.disabled = true;
        actionBtn.disabled = true; // Ù‚ÙÙ„ Ø§Ù„Ø²Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø­ØªÙ‰ ÙŠÙƒØªØ¨ Ø§Ù„ÙƒÙ„Ù…Ø©
        helpWordInput.focus();
        
        helpCount--;
        helpBtn.innerText = `ğŸ’¡ Ø·Ù„Ø¨ Ù…Ø³Ø§Ø¹Ø¯Ø© (${helpCount})`;
    }

    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…ÙƒØªÙˆØ¨Ø©
    function validateHelpWord(val) {
        const words = activeData[currentIdx].full.trim().split(/\s+/);
        if (words.length < 2) { 
            unlockAfterHelp(); // Ù„Ùˆ Ø¢ÙŠØ© Ù…Ù† ÙƒÙ„Ù…Ø© ÙˆØ§Ø­Ø¯Ø©
            return;
        }
        
        const target = words[1].replace(/[^\u0621-\u064A]/g, ''); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ´ÙƒÙŠÙ„
        const user = val.trim().replace(/[^\u0621-\u064A]/g, '');

        if (user === target) {
            unlockAfterHelp();
        }
    }

    function unlockAfterHelp() {
        isHelpActive = false;
        helpInputArea.style.display = 'none';
        actionBtn.disabled = false;
        actionBtn.innerText = "Ø£Ø­Ø³Ù†Øª! Ø§ÙÙƒÙ’Ø´ÙÙÙ Ø§Ù„Ù’Ø¢ÙŠÙØ©Ù Ø§Ù„Ø¢Ù†";
    }

    function startTimer() {
        startTime = Date.now();
        timerInterval = setInterval(() => {
            timerDisplay.innerText = ((Date.now() - startTime) / 1000).toFixed(1);
        }, 100);
    }

    function stopTimer() { clearInterval(timerInterval); timerInterval = null; }

    actionBtn.onclick = function() {
        if(isHelpActive) return;
        if(!isRevealed) {
            if(!timerInterval) startTimer();
            reveal();
        } else {
            prepareNext();
        }
    };

    function reveal() {
        stopTimer();
        isRevealed = true;
        ayaText.innerText = activeData[currentIdx].full;
        ayaText.style.opacity = "1";
        ayaText.classList.remove('is-hidden');
        actionBtn.innerText = "Ø§Ù„Ù’Ø¢ÙŠÙØ©Ù Ø§Ù„ØªÙ‘ÙØ§Ù„ÙÙŠÙØ©Ù";
        
        helpSection.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙƒØ´Ù
        saadiBtn.style.display = 'block';
        karimBtn.style.display = 'block';
        
        infoCardBox.innerHTML = activeData[currentIdx].meta;
        infoCardBox.style.display = 'block';

        const units = document.querySelectorAll('.heat-unit');
        if(units[currentIdx]) units[currentIdx].style.background = 'var(--main)';
    }

    async function getSaadiTafseer() {
        karimBox.style.display = 'none';
        if (tafseerSaadi.style.display === 'block') {
            tafseerSaadi.style.display = 'none';
            return;
        }
        tafseerSaadi.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ³ÙŠØ±...";
        tafseerSaadi.style.display = 'block';
        try {
            const res = await fetch(`https://api.alquran.cloud/v1/ayah/${select.value}:${currentIdx + 1}/ar.muyassar`);
            const json = await res.json();
            tafseerSaadi.innerHTML = `<b>Ø§Ù„ØªÙØ³ÙŠØ± Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ (Ø§Ù„Ù…ÙŠØ³Ø±):</b><br>${json.data.text}`;
        } catch(e) {
            tafseerSaadi.innerHTML = "Ø¹Ø°Ø±Ø§Ù‹ØŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ³ÙŠØ± Ø­Ø§Ù„ÙŠØ§Ù‹.";
        }
    }

    function getKarimGuidance() {
        tafseerSaadi.style.display = 'none';
        if (karimBox.style.display === 'block') {
            karimBox.style.display = 'none';
            return;
        }
        karimBox.style.display = 'block';
        
        const text = activeData[currentIdx].full;
        let guidance = `<b>ğŸ™ï¸ Ø¥Ø±Ø´Ø§Ø¯Ø§Øª ÙƒØ±ÙŠÙ… Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© Ù„ØªØµØ­ÙŠØ­ Ø§Ù„ØªÙ„Ø§ÙˆØ©:</b><hr style="border:0; border-top:1px solid var(--blue); margin:10px 0;">`;
        guidance += `ğŸ”¹ <b>Ù…ÙˆØ§Ø²ÙŠÙ† Ø§Ù„Ù…Ø¯ÙˆØ¯:</b> Ø§Ø­Ø±Øµ Ø¹Ù„Ù‰ ØªØ³ÙˆÙŠØ© Ø§Ù„Ù…Ø¯ÙˆØ¯Ø› ÙØ§Ù„Ù…Ø¯ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ Ø­Ø±ÙƒØªØ§Ù†ØŒ ÙˆØ§Ù„Ù…Ø¯ Ø§Ù„Ù…ØªØµÙ„ ÙˆØ§Ù„Ù…Ù†ÙØµÙ„ 4 Ø£Ùˆ 5 Ø­Ø±ÙƒØ§Øª.<br><br>`;
        if (text.includes('Ù†') || text.includes('Ù…')) {
            guidance += `ğŸ”¹ <b>Ø£Ø­ÙƒØ§Ù… Ø§Ù„ØºÙ†Ø©:</b> Ø§Ù†ØªØ¨Ù‡ Ù„Ù„Ù†ÙˆÙ† ÙˆØ§Ù„Ù…ÙŠÙ… Ø§Ù„Ù…Ø´Ø¯Ø¯ØªÙŠÙ†ØŒ ÙˆØ±Ø§Ø¹Ù Ù…Ø±Ø§ØªØ¨ Ø§Ù„ØºÙ†Ø© ÙÙŠ Ø§Ù„Ø¥Ø¯ØºØ§Ù… ÙˆØ§Ù„Ø¥Ø®ÙØ§Ø¡.<br><br>`;
        }
        guidance += `ğŸ”¹ <b>ØµÙØ§Øª Ø§Ù„Ø­Ø±ÙˆÙ:</b> Ø£Ø¹Ø·Ù Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ù…Ø³ØªØ¹Ù„ÙŠØ© Ø­Ù‚Ù‡Ø§ Ù…Ù† Ø§Ù„ØªÙØ®ÙŠÙ…ØŒ ÙˆØ§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ù…Ø³ØªÙÙ„Ø© Ø­Ù‚Ù‡Ø§ Ù…Ù† Ø§Ù„ØªØ±Ù‚ÙŠÙ‚.<br><br>`;
        guidance += `ğŸ”¹ <b>ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù† Ø§Ù„Ù„Ø­Ù† Ø§Ù„Ø¬Ù„ÙŠ:</b> Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø¥Ø¹Ø±Ø§Ø¨ÙŠØ© Ø¨Ø¯Ù‚Ø©Ø› ÙØ§Ù„Ù„Ø­Ù† ÙÙŠÙ‡Ø§ ÙŠØºÙŠØ± Ø§Ù„Ù…Ø¹Ù†Ù‰.<br><br>`;
        guidance += `ğŸ”¹ <b>Ø§Ù„ÙˆÙ‚Ù ÙˆØ§Ù„Ø§Ø¨ØªØ¯Ø§Ø¡:</b> Ù‚Ù Ø¹Ù†Ø¯ Ø±Ø¤ÙˆØ³ Ø§Ù„Ø¢ÙŠØ© Ø£Ùˆ Ø­ÙŠØ« ÙŠØªÙ… Ø§Ù„Ù…Ø¹Ù†Ù‰ØŒ ÙˆØªØ¬Ù†Ø¨ Ø§Ù„ÙˆÙ‚Ù Ø§Ù„Ù‚Ø¨ÙŠØ­.<br><br>`;
        guidance += `<small>ğŸ’¡ Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯Ø§Øª ÙˆØ¶Ø¹Øª Ù„ØªØ°ÙƒØ±Ùƒ Ø¨Ø£ØµÙˆÙ„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©ØŒ ÙˆØ§Ù„Ø²Ù… Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø§Ù„ØªÙ„Ù‚ÙŠ Ù…Ù† Ø£ÙÙˆØ§Ù‡ Ø§Ù„Ù…Ø´Ø§ÙŠØ® Ø§Ù„Ù…ØªÙ‚Ù†ÙŠÙ†.</small>`;
        
        karimBox.innerHTML = guidance;
    }

    function prepareNext() {
        if (currentIdx < activeData.length - 1) {
            ayaText.style.opacity = "0";
            ayaText.classList.add('is-hidden'); 
            
            currentIdx++;
            resetAyaUI();
            startTimer();
        } else {
            alert("ØªÙ…Øª Ø§Ù„Ø³ÙˆØ±Ø© Ø¨Ø­Ù…Ø¯ Ø§Ù„Ù„Ù‡");
        }
    }

    document.getElementById('saveProgressBtn').onclick = function() {
        const data = { surah: select.value, pos: currentIdx };
        localStorage.setItem('quran_save', JSON.stringify(data));
        document.getElementById('saveStatus').innerText = `âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸: ${surahNames[select.value-1]} - Ø¢ÙŠØ© ${currentIdx + 1}`;
        setTimeout(() => document.getElementById('saveStatus').innerText = "", 4000);
    };

    window.onload = function() {
        const saved = localStorage.getItem('quran_save');
        if (saved) {
            const data = JSON.parse(saved);
            select.value = data.surah;
            select.onchange(null, data.pos);
            document.getElementById('saveStatus').innerText = "ğŸ“ ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¢Ø®Ø± Ù…ÙƒØ§Ù† ØªÙˆÙ‚ÙØª Ø¹Ù†Ø¯Ù‡";
        }
    };
</script>
</body>
</html>
