<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>الْمُصَحِّحُ الصَّارِمُ | نَفَحَاتٌ إِيمَانِيَّةٌ</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --main-color: #2ecc71; --error-color: #e74c3c; --gold: #d4af37; --bg: #0a0a0a; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: white; margin: 0; font-family: 'Cairo', sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 15px; }
        
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { color: var(--gold); font-size: 1.4rem; margin: 0; font-weight: 900; }

        .quran-box { width: 100%; max-width: 500px; background: #111; padding: 25px; border-radius: 25px; border: 1px solid #222; border-top: 4px solid var(--main-color); box-shadow: 0 20px 40px rgba(0,0,0,0.8); text-align: center; }
        
        /* منطقة عرض الآية - واضحة جداً ولا يوجد سواد */
        .aya-text { font-size: 1.8rem; min-height: 140px; display: flex; align-items: center; justify-content: center; line-height: 1.8; margin-bottom: 20px; padding: 20px; background: #000; border-radius: 15px; border: 2px solid #1a1a1a; transition: 0.3s; }
        .current-target { color: #888; } /* لون رمادي واضح للقراءة */
        .success-flash { color: var(--main-color) !important; text-shadow: 0 0 20px var(--main-color); }
        .error-flash { color: var(--error-color) !important; text-shadow: 0 0 20px var(--error-color); }

        canvas { width: 100%; height: 50px; background: #000; border-radius: 25px; margin-bottom: 20px; }

        .btn-record { width: 100%; padding: 18px; border: none; border-radius: 15px; font-family: 'Cairo'; font-weight: 900; cursor: pointer; font-size: 1.2rem; background: var(--main-color); color: #000; box-shadow: 0 6px #1e8449; transition: 0.1s; }
        .btn-record.active { background: var(--error-color); color: #fff; box-shadow: 0 6px #c0392b; transform: translateY(3px); }

        #monitor { margin-top: 20px; padding: 15px; background: #000; border-radius: 12px; border: 1px dashed #333; min-height: 60px; width: 100%; }
        .status-container { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .status-dot { width: 15px; height: 15px; background: #333; border-radius: 50%; transition: 0.3s; }
        .status-listening { background: #f1c40f; box-shadow: 0 0 10px #f1c40f; }
        .status-error { background: var(--error-color); box-shadow: 0 0 10px var(--error-color); }
        
        .log-text { font-size: 0.9rem; color: #666; }
        .user-said { color: var(--gold); font-weight: bold; }
    </style>
</head>
<body>

<div class="header">
    <h1>الْمُصَحِّحُ الصَّارِمُ (لَا لِلْغِشِّ)</h1>
    <p style="color: #666; font-size: 0.8rem;">سُورَةُ النَّبَأِ - نِظَامُ الرَّقَابَةِ الصَّوْتِيَّةِ</p>
</div>

<div class="quran-box">
    <div class="aya-text" id="ayaDisplay">
        <span class="current-target" id="textTarget">اضْغَطْ لِلْبَدْءِ</span>
    </div>
    
    <canvas id="viz"></canvas>
    
    <button class="btn-record" id="micBtn">بَدْءُ التَّسْمِيعِ الْآنَ</button>

    <div id="monitor">
        <div class="status-container">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusLabel" style="font-size: 0.8rem; font-weight: bold;">النِّظَامُ مُتَوَقِّفٌ</span>
        </div>
        <div class="log-text">مَا سَمِعْتُهُ: <span class="user-said" id="spokenText">...</span></div>
    </div>
</div>

<script>
    // النصوص الأصلية والمبسطة للمقارنة
    const ayasDisplay = ["عَمَّ يَتَسَاءَلُونَ (1)", "عَنِ النَّبَإِ الْعَظِيمِ (2)", "الَّذِي هُمْ فِيهِ مُخْتَلِفُونَ (3)", "كَلَّا سَيَعْلَمُونَ (4)", "ثُمَّ كَلَّا سَيَعْلَمُونَ (5)"];
    const ayasCompare = ["عم يتساءلون", "عن النبا العظيم", "الذي هم فيه مختلفون", "كلا سيعلمون", "ثم كلا سيعلمون"];

    let currentIdx = 0;
    let isListening = false;
    const textTarget = document.getElementById('textTarget');
    const spokenText = document.getElementById('spokenText');
    const statusDot = document.getElementById('statusDot');
    const statusLabel = document.getElementById('statusLabel');
    const micBtn = document.getElementById('micBtn');

    // إعداد المحرك الصوتي بدقة عالية
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'ar-SA';
    recognition.interimResults = true;
    recognition.continuous = true;

    recognition.onstart = () => {
        statusDot.className = "status-dot status-listening";
        statusLabel.innerText = "أَنَا أَسْمَعُكَ.. اقْرَأْ بِدِقَّةٍ";
        textTarget.innerText = ayasDisplay[currentIdx];
    };

    recognition.onresult = (event) => {
        let transcript = "";
        for (let i = event.resultIndex; i < event.results.length; ++i) {
            transcript += event.results[i][0].transcript;
        }
        
        spokenText.innerText = transcript;
        checkTilaowa(transcript.trim());
    };

    function checkTilaowa(input) {
        let target = ayasCompare[currentIdx].replace(/[أإآ]/g, 'ا').replace(/ة/g, 'ه');
        let processedInput = input.replace(/[أإآ]/g, 'ا').replace(/ة/g, 'ه');

        // إذا نطق المستخدم شيئاً وبدأ يبتعد عن النص الصحيح
        if (processedInput.length >= target.length / 2) {
            if (processedInput.includes(target)) {
                handleSuccess();
            } else {
                // اكتشاف الخطأ وتنبيه المستخدم
                statusDot.className = "status-dot status-error";
                statusLabel.innerText = "خَطَأٌ فِي النُّطْقِ! أَعِدْ الْآيَةَ";
            }
        }
    }

    function handleSuccess() {
        textTarget.className = "success-flash";
        statusDot.style.background = "#2ecc71";
        statusLabel.innerText = "صَحِيحٌ! انْتَقِلْ لِلْآيَةِ التَّالِيَةِ";
        
        setTimeout(() => {
            if (currentIdx < ayasDisplay.length - 1) {
                currentIdx++;
                textTarget.innerText = ayasDisplay[currentIdx];
                textTarget.className = "current-target";
                statusDot.className = "status-dot status-listening";
                spokenText.innerText = "...";
                // تصفير نتائج التعرف لبدء آية جديدة
                recognition.stop();
                setTimeout(() => recognition.start(), 100);
            } else {
                textTarget.innerText = "تَمَّ التَّسْمِيعُ بِنَجَاحٍ!";
                recognition.stop();
            }
        }, 1500);
    }

    micBtn.onclick = () => {
        if (!isListening) {
            recognition.start();
            isListening = true;
            micBtn.innerText = "إِيقَافُ التَّسْمِيعِ";
            micBtn.classList.add('active');
            startVisualizer();
        } else {
            location.reload();
        }
    };

    function startVisualizer() {
        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
            const audioCtx = new AudioContext();
            const analyser = audioCtx.createAnalyser();
            const source = audioCtx.createMediaStreamSource(stream);
            source.connect(analyser);
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            const canvas = document.getElementById('viz');
            const ctx = canvas.getContext('2d');
            function draw() {
                if(!isListening) return;
                requestAnimationFrame(draw);
                analyser.getByteFrequencyData(dataArray);
                ctx.fillStyle = "#000"; ctx.fillRect(0, 0, canvas.width, canvas.height);
                let x = 0;
                for(let i=0; i<dataArray.length; i+=10) {
                    let barHeight = dataArray[i]/2;
                    ctx.fillStyle = "#2ecc71";
                    ctx.fillRect(x, (canvas.height - barHeight)/2, 2, barHeight);
                    x += 4;
                }
            }
            draw();
        }).catch(() => {});
    }
</script>
</body>
</html>
