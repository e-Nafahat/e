<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>منصة نفحات | الإجازة التمهيدية</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy: #001f3f;
            --gold: #b8860b;
            --emerald: #1a5d1a;
            --bg: #f4f7f6;
            --white: #ffffff;
            --red: #e74c3c;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); color: var(--navy); margin: 0; padding: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }

        .screen { display: none; width: 100%; padding: 15px; flex-direction: column; align-items: center; }
        .active-screen { display: flex; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* الشعار والتنسيقات العلوية */
        .register-header { text-align: center; margin: 15px 0; }
        .register-header img { width: 60px; height: 60px; object-fit: contain; border-radius: 50%; }
        .register-header h1 { font-size: 1.1rem; color: var(--navy); margin-top: 8px; font-weight: 900; }

        .header { text-align: center; margin-bottom: 15px; width: 100%; }
        .header img { width: 45px; height: 45px; object-fit: contain; border-radius: 50%; }
        .header h1 { font-size: 1rem; margin-top: 5px; font-weight: 900; }

        /* البطاقات */
        .main-card { background: var(--white); border-radius: 20px; padding: 20px; width: 100%; max-width: 450px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-bottom: 5px solid var(--gold); }
        .compact-card { max-width: 380px; }

        /* المدخلات */
        .input-group { margin-bottom: 15px; text-align: right; width: 100%; }
        .input-group label { display: block; font-weight: 700; margin-bottom: 5px; font-size: 0.85rem; }
        .input-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 12px; font-size: 0.9rem; outline: none; }

        /* شبكة الأجزاء */
        .juz-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 15px 0; width: 100%; }
        .juz-item { background: #f0f2f5; padding: 10px 2px; border-radius: 10px; text-align: center; cursor: pointer; font-weight: 700; border: 2px solid transparent; font-size: 0.85rem; }
        .juz-item.active { border-color: var(--gold); background: #fffcf0; color: var(--gold); }

        /* أزرار الاختبار */
        .test-selector { display: none; width: 100%; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .btn-test { padding: 12px 5px; border-radius: 10px; border: none; font-weight: 700; font-size: 0.75rem; position: relative; cursor: pointer; }
        .btn-compulsory { background: var(--navy); color: var(--gold); }
        .btn-optional { background: #eee; color: #666; }
        .btn-active { outline: 3px solid var(--gold); }
        .badge { position: absolute; top: -5px; right: -5px; background: var(--red); color: white; font-size: 0.55rem; padding: 2px 4px; border-radius: 5px; }

        /* منطقة الاختبار */
        .quiz-header { display: flex; justify-content: space-between; align-items: center; background: var(--navy); color: white; padding: 10px 15px; border-radius: 12px; margin-bottom: 15px; width: 100%; max-width: 450px; }
        .timer-circle { width: 40px; height: 40px; border: 2px solid var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; }
        
        .question-card { background: white; padding: 20px; border-radius: 15px; width: 100%; max-width: 450px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .q-hint { color: var(--gold); font-size: 0.8rem; font-weight: 700; margin-bottom: 8px; }
        .q-text { font-family: 'Amiri', serif; font-size: 1.4rem; line-height: 1.6; color: var(--navy); font-weight: 700; margin: 10px 0; }
        
        .options-grid { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; width: 100%; max-width: 450px; }
        .option-btn { background: white; border: 1px solid #ddd; padding: 12px; border-radius: 10px; font-family: 'Amiri'; font-size: 1.1rem; font-weight: 700; text-align: center; }
        .option-btn.correct { background: #d4edda !important; border-color: #28a745 !important; }
        .option-btn.wrong { background: #f8d7da !important; border-color: #dc3545 !important; }

        .write-input { width: 100%; padding: 12px; border: 2px solid var(--gold); border-radius: 10px; font-family: 'Amiri'; font-size: 1.2rem; text-align: center; outline: none; background: #fffcf0; }
        .submit-btn { width: 100%; max-width: 450px; padding: 15px; background: var(--emerald); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 10px; }
        
        /* نافذة التنبيه الذكية (Alert Modal) */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,31,63,0.85); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); padding: 20px; }
        .smart-alert { background: white; width: 100%; max-width: 350px; border-radius: 25px; padding: 30px 20px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.3); transform: scale(0.8); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .modal-overlay.active { display: flex; }
        .modal-overlay.active .smart-alert { transform: scale(1); }
        .alert-icon { font-size: 50px; color: var(--gold); margin-bottom: 15px; }
        .alert-title { font-weight: 900; font-size: 1.2rem; color: var(--navy); margin-bottom: 10px; }
        .alert-msg { font-size: 0.95rem; line-height: 1.6; color: #555; margin-bottom: 20px; }
        .time-badge { background: #fff4e5; color: #b8860b; padding: 8px 15px; border-radius: 10px; font-weight: 900; display: inline-block; margin-top: 10px; border: 1px dashed var(--gold); }
        .modal-close-btn { width: 100%; padding: 12px; background: var(--navy); color: var(--gold); border: none; border-radius: 12px; font-weight: 700; cursor: pointer; }

        /* ضبط الشهادة المطور */
        #cert-container { width: 100%; display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
        #cert-wrapper { 
            width: 850px; height: 600px; 
            background: white; border: 18px double var(--gold); 
            padding: 0; text-align: center; 
            position: absolute; left: -9999px;
            background-image: radial-gradient(circle, #fffaf0 0%, #ffffff 100%);
            display: flex; flex-direction: column;
        }
        .cert-preview-img { width: 100%; max-width: 450px; height: auto; border: 2px solid var(--gold); border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); }

        .cert-inner { border: 1px solid rgba(0,31,63,0.1); height: 100%; margin: 15px; padding: 20px; position: relative; display: flex; flex-direction: column; justify-content: space-between; align-items: center; }
        
        .cert-top-row { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .cert-header-site { text-align: right; }
        .cert-header-site .ar { font-size: 1.5rem; font-weight: 900; color: var(--navy); display: block; letter-spacing: 0px; line-height: 1; }
        .cert-header-site .en { font-size: 0.85rem; color: var(--navy); display: block; opacity: 0.8; line-height: 1; margin-top: 2px; }
        .cert-logo { width: 85px; height: 85px; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }

        .cert-content-box { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; width: 100%; gap: 5px; }
        
        .cert-title { font-family: 'Amiri'; font-size: 3.5rem; color: var(--emerald); margin: 0; line-height: 1; font-weight: 700; }
        .cert-test-type { font-weight: 700; color: var(--gold); font-size: 1.2rem; margin: 0; }
        
        .cert-body-text { font-size: 1.3rem; margin: 0; color: #333; line-height: 1.2; }
        .cert-name { font-size: 2.8rem; border-bottom: 2px solid var(--gold); display: inline-block; padding: 0 40px; color: var(--navy); margin: 5px 0; font-family: 'Amiri'; max-width: 80%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; line-height: 1.1; }

        .cert-info-line { font-size: 1.2rem; margin: 0; color: #444; line-height: 1.2; }

        .cert-score-box { background: #fdfaf0; border: 1px solid #eee; border-radius: 10px; padding: 8px 30px; margin: 5px auto; display: flex; gap: 40px; font-weight: 900; font-size: 1.1rem; }

        .cert-alliance { font-size: 1rem; font-weight: 700; color: var(--navy); font-style: italic; margin-top: 5px; border-top: 1px solid #f0f0f0; padding-top: 5px; width: 60%; align-self: center; }

        .cert-footer { width: 100%; display: flex; justify-content: space-between; align-items: flex-end; margin-top: 5px; }
        .footer-info { text-align: right; font-size: 0.8rem; line-height: 1.2; color: #666; }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--gold); border-radius: 50%; width: 35px; height: 35px; animation: spin 1s linear infinite; display: none; margin: 15px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .reveal-box { margin-top: 12px; padding: 10px; background: #e8f5e9; border-radius: 10px; color: #2e7d32; font-family: 'Amiri'; font-weight: bold; display: none; }
    </style>
</head>
<body>

<div id="smart-modal" class="modal-overlay">
    <div class="smart-alert">
        <div class="alert-icon">⏳</div>
        <div class="alert-title">قيد الاختبار النشط</div>
        <div class="alert-msg">
            نعتذر منك، لا يُسمح بإعادة نفس الاختبار إلا بعد مرور أسبوع لإتاحة الفرصة للمراجعة والتمكين.
            <div id="remaining-time" class="time-badge"></div>
        </div>
        <button class="modal-close-btn" onclick="closeModal()">فهمت ذلك</button>
    </div>
</div>

<div id="screen-register" class="screen active-screen">
    <div class="register-header">
        <img src="../leader/LogoNafahat.png" alt="Logo">
        <h1>طلب الاشتراك في الإجازة التمهيدية</h1>
    </div>
    <div class="main-card compact-card">
        <div style="text-align: right; margin-bottom: 15px;">
            <p style="font-size: 0.8rem; line-height: 1.6; color: #555; margin: 0;">
                مرحباً بك في برنامج الإجازة.<br>
                • اختبارات (أكمل الآية) و (ضبط الفواصل) <span style="color: var(--gold); font-weight: bold;">إجبارية</span>.<br>
                • (اسم السورة) إجباري بعد الجزء السابع.<br>
                • <span style="font-weight: bold; color: var(--red);">تنبيه:</span> لا يمكنك الإعادة إلا بعد مرور 7 أيام.
            </p>
        </div>
        <div class="input-group">
            <label>اسم الطالب / الطالبة</label>
            <input type="text" id="user-name" placeholder="ادخل الاسم الثلاثي">
        </div>
        <div class="input-group">
            <label>البلد</label>
            <input type="text" id="user-country" placeholder="مثلاً: مصر، المغرب، السعودية">
        </div>
        <button class="submit-btn" onclick="goToSetup()">متابعة للوحة التحكم</button>
    </div>
</div>

<div id="screen-setup" class="screen">
    <div class="header"><img src="../leader/LogoNafahat.png"><h1>منصة الإجازة التمهيدية</h1></div>
    <div class="main-card">
        <div style="text-align:right; font-weight:900; font-size:0.9rem;">اختر الجزء (مرحلة):</div>
        <div class="juz-grid" id="juz-grid"></div>
        <div id="test-selector-area" class="test-selector">
            <button class="btn-test btn-compulsory" id="btn-completion" onclick="selectType('completion', this)">أكمل الآية <span class="badge">إجباري</span></button>
            <button class="btn-test btn-compulsory" id="btn-terminator" onclick="selectType('terminator', this)">ضبط الفواصل <span class="badge">إجباري</span></button>
            <button class="btn-test btn-optional" id="btn-surah" onclick="selectType('surahName', this)">ما اسم السورة؟</button>
            <button class="btn-test btn-optional" id="btn-culture" onclick="selectType('culture', this)">ثقافة قرآنية</button>
        </div>
        <button id="master-start-btn" class="submit-btn" style="display:none; background: var(--navy); color: var(--gold);" onclick="validateAndStart()">بدء الاختبار</button>
        <div id="main-loader" class="loader"></div>
    </div>
</div>

<div id="screen-quiz" class="screen">
    <div class="quiz-header">
        <div id="q-counter">السؤال: 1 / 20</div>
        <div class="timer-circle" id="timer-display">15</div>
    </div>
    <div class="question-card">
        <div id="q-hint" class="q-hint"></div>
        <div id="q-text" class="q-text">جاري التحميل...</div>
        <div id="reveal-ans" class="reveal-box"></div>
    </div>
    <div id="interaction-area" class="options-grid"></div>
</div>

<div id="screen-result" class="screen">
    <div id="cert-wrapper">
        <div class="cert-inner">
            <div class="cert-top-row">
                <div class="cert-header-site">
                    <span class="ar">نفحات ايمانية</span>
                    <span class="en">Nafahat Imaniyah</span>
                </div>
                <img src="../leader/LogoNafahat.png" class="cert-logo">
            </div>
            
            <div class="cert-content-box">
                <h1 class="cert-title">شهادة إتقان</h1>
                <div class="cert-test-type" id="cert-type-label">نوع الاختبار:</div>
                
                <p class="cert-body-text">بفضل الله وتوفيقه، أتم الطالب/الطالبة:</p>
                <div id="cert-user-name" class="cert-name"></div>
                
                <p class="cert-info-line">من دولة: <span id="cert-user-country" style="font-weight:bold; color: var(--navy);"></span></p>
                <p class="cert-info-line">اجتياز الاختبار التمهيدي في <b>الجزء <span id="cert-juz"></span></b> بنجاح</p>
                
                <div class="cert-score-box">
                    <span>الدرجة: <span id="cert-score"></span> / 20</span>
                    <span>النقاط: <span id="cert-pts"></span></span>
                </div>

                <div class="cert-alliance">
                    "لن يصلح آخر هذه الأمة إلا بما صلح به أولها"
                </div>
            </div>

            <div class="cert-footer">
                <div class="footer-info">
                    تاريخ الإصدار: <span id="cert-date"></span><br>
                    كود التصديق: NAF-2026-OK
                </div>
                <div style="font-size: 0.7rem; opacity: 0.4; font-weight: bold;">منصة نفحات للقرآن الكريم</div>
            </div>
        </div>
    </div>

    <div id="cert-container">
        <p style="font-weight: bold; color: var(--navy);">معاينة الشهادة النهائية:</p>
        <img id="cert-preview" class="cert-preview-img" src="" alt="Certificate Preview">
    </div>

    <button id="download-btn" class="submit-btn" onclick="downloadCert()">حفظ الشهادة في الاستوديو</button>
    <button class="submit-btn" style="background: var(--navy);" onclick="location.reload()">العودة للرئيسية</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
    let appData = {
        userName: '', country: '', selectedJuz: null, quizType: '',
        questions: [], currentIdx: 0, score: 0, timeLeft: 15, timer: null,
        isAnswering: false, surahNamesInJuz: []
    };

    const culturalStore = [
        { q: "ما هي السورة التي تسمى (سنام القرآن)؟", ans: "البقرة", opts: ["البقرة", "آل عمران", "يس"], hint: "ثقافة قرآنية" },
        { q: "ما هي السورة التي تنتهي بذكر نبيين؟", ans: "الأعلى", opts: ["الأعلى", "الشمس", "التين"], hint: "ثقافة قرآنية" },
        { q: "من هو النبي الذي ذكر في القرآن أكثر من غيره؟", ans: "موسى عليه السلام", opts: ["موسى عليه السلام", "إبراهيم عليه السلام", "محمد ﷺ"], hint: "ثقافة قرآنية" },
        { q: "كم عدد سجدات التلاوة في القرآن الكريم؟", ans: "15 سجدة", opts: ["15 سجدة", "14 سجدة", "12 سجدة"], hint: "ثقافة قرآنية" },
        { q: "ما هي أطول آية في القرآن الكريم؟", ans: "آية الدين", opts: ["آية الدين", "آية الكرسي", "آية المداينة"], hint: "ثقافة قرآنية" },
        { q: "ما هي السورة التي تسمى (قلب القرآن)؟", ans: "يس", opts: ["يس", "الإخلاص", "الفاتحة"], hint: "ثقافة قرآنية" },
        { q: "ما هي السورة التي بدأت باسم ثمرتين؟", ans: "التين", opts: ["التين", "النجم", "الضحى"], hint: "ثقافة قرآنية" },
        { q: "سورة يطلق عليها (عروس القرآن)؟", ans: "الرحمن", opts: ["الرحمن", "يس", "الملك"], hint: "ثقافة قرآنية" },
        { q: "كم عدد أجزاء القرآن الكريم؟", ans: "30 جزء", opts: ["30 جزء", "60 جزء", "114 جزء"], hint: "ثقافة قرآنية" },
        { q: "ما هي السورة التي تخلو من حرف الراء؟", ans: "الإخلاص", opts: ["الإخلاص", "الفلق", "الناس"], hint: "ثقافة قرآنية" },
        { q: "ما هي السورة التي تسمى (براءة)؟", ans: "التوبة", opts: ["التوبة", "الأنفال", "المائدة"], hint: "ثقافة قرآنية" },
        { q: "أين نزل القرآن الكريم أول مرة؟", ans: "غار حراء", opts: ["غار حراء", "المسجد الحرام", "المدينة المنورة"], hint: "ثقافة قرآنية" },
        { q: "كم عدد السور المكية في القرآن الكريم؟", ans: "86 سورة", opts: ["86 سورة", "28 سورة", "114 سورة"], hint: "ثقافة قرآنية" },
        { q: "ما هي السورة التي ذكرت فيها البسملة مرتين؟", ans: "النمل", opts: ["النمل", "النحل", "الفاتحة"], hint: "ثقافة قرآنية" },
        { q: "ما هي السورة التي تسمى (سورة النعم)؟", ans: "النحل", opts: ["النحل", "الأنعام", "فاطر"], hint: "ثقافة قرآنية" },
        { q: "ما هي أقصر سورة في القرآن الكريم؟", ans: "الكوثر", opts: ["الكوثر", "الإخلاص", "العصر"], hint: "ثقافة قرآنية" },
        { q: "ما هي السورة التي تسمى (السبع المثاني)؟", ans: "الفاتحة", opts: ["الفاتحة", "البقرة", "يس"], hint: "ثقافة قرآنية" },
        { q: "كم عدد السور المدنية في القرآن الكريم؟", ans: "28 سورة", opts: ["28 سورة", "86 سورة", "30 سورة"], hint: "ثقافة قرآنية" },
        { q: "ما هي أطول سورة في القرآن الكريم؟", ans: "البقرة", opts: ["البقرة", "النساء", "المائدة"], hint: "ثقافة قرآنية" },
        { q: "ما هي السورة التي تعدل ثلث القرآن؟", ans: "الإخلاص", opts: ["الإخلاص", "الفاتحة", "الكافرون"], hint: "ثقافة قرآنية" },
        { q: "كم عدد أحزاب القرآن الكريم؟", ans: "60 حزباً", opts: ["60 حزباً", "30 حزباً", "120 حزباً"], hint: "ثقافة قرآنية" },
        { q: "ما هي السورة التي تسمى (سورة القتال)؟", ans: "محمد", opts: ["محمد", "الفتح", "الأنفال"], hint: "ثقافة قرآنية" },
        { q: "من هو الصحابي الوحيد الذي ذكر اسمه في القرآن؟", ans: "زيد بن حارثة", opts: ["زيد بن حارثة", "أبو بكر الصديق", "عمر بن الخطاب"], hint: "ثقافة قرآنية" },
        { q: "ما هي السورة التي بدأت بلفظ (يا أيها النبي)؟", ans: "الأحزاب", opts: ["الأحزاب", "الفتح", "النور"], hint: "ثقافة قرآنية" },
        { q: "ما هي السورة التي تسمى (الفاضحة)؟", ans: "التوبة", opts: ["التوبة", "المنافقون", "الأحزاب"], hint: "ثقافة قرآنية" },
        { q: "في أي جزء تقع سورة الحج؟", ans: "الجزء 17", opts: ["الجزء 17", "الجزء 16", "الجزء 18"], hint: "ثقافة قرآنية" },
        { q: "ما هي السورة التي تسمى (سورة بني إسرائيل)؟", ans: "الإسراء", opts: ["الإسراء", "القصص", "النمل"], hint: "ثقافة قرآنية" },
        { q: "كم عدد السور التي افتتحت بالحروف المقطعة؟", ans: "29 سورة", opts: ["29 سورة", "30 سورة", "28 سورة"], hint: "ثقافة قرآنية" },
        { q: "ما هي السورة التي تسمى (الحواميم)؟", ans: "غافر وأخواتها", opts: ["غافر وأخواتها", "الشورى", "يس"], hint: "ثقافة قرآنية" },
        { q: "سورة يطلق عليها (فسطاط القرآن)؟", ans: "البقرة", opts: ["البقرة", "يس", "الكهف"], hint: "ثقافة قرآنية" }
    ];

    const grid = document.getElementById('juz-grid');
    for(let i=1; i<=30; i++) {
        let div = document.createElement('div');
        div.className = 'juz-item';
        div.innerText = i;
        div.onclick = () => selectJuz(i, div);
        grid.appendChild(div);
    }

    function closeModal() {
        document.getElementById('smart-modal').classList.remove('active');
    }

    function goToSetup() {
        appData.userName = document.getElementById('user-name').value;
        appData.country = document.getElementById('user-country').value;
        if(!appData.userName || !appData.country) return alert("يرجى إدخال البيانات");
        document.getElementById('screen-register').classList.remove('active-screen');
        document.getElementById('screen-setup').classList.add('active-screen');
    }

    function selectJuz(num, el) {
        appData.selectedJuz = num;
        document.querySelectorAll('.juz-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('test-selector-area').style.display = 'grid';
        const surahBtn = document.getElementById('btn-surah');
        if(num > 7) {
            surahBtn.innerHTML = `ما اسم السورة؟ <span class="badge">إجباري</span>`;
            surahBtn.className = "btn-test btn-compulsory";
        } else {
            surahBtn.innerHTML = `ما اسم السورة؟`;
            surahBtn.className = "btn-test btn-optional";
        }
    }

    function selectType(type, el) {
        appData.quizType = type;
        document.querySelectorAll('.btn-test').forEach(b => b.classList.remove('btn-active'));
        el.classList.add('btn-active');
        document.getElementById('master-start-btn').style.display = 'block';
    }

    function normalizeArabic(text) {
        if (!text) return "";
        return text.replace(/[\u064B-\u065F]/g, "").replace(/[أإآ]/g, "ا").replace(/ة/g, "ه").replace(/[ىي]/g, "ي").replace(/[ؤئ]/g, "ء").replace(/\u0640/g, "").replace(/\s+/g, " ").trim();
    }

    function shuffle(array) {
        let currentIndex = array.length, randomIndex;
        while (currentIndex != 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
        }
        return array;
    }

    // دالة فحص القيد الزمني بشكل "ذكي"
    function checkTestLock() {
        const lockKey = `lock_${appData.quizType}_${appData.selectedJuz}`;
        const lastTestTime = localStorage.getItem(lockKey);
        
        if (lastTestTime) {
            const now = new Date().getTime();
            const sevenDaysInMs = 7 * 24 * 60 * 60 * 1000;
            const timeLeft = lastTestTime * 1 + sevenDaysInMs - now;

            if (timeLeft > 0) {
                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                
                // إظهار النافذة المودال بدلاً من alert
                document.getElementById('remaining-time').innerText = `المتبقي: ${days} يوم و ${hours} ساعة`;
                document.getElementById('smart-modal').classList.add('active');
                return false;
            }
        }
        return true;
    }

    function saveTestDate() {
        const lockKey = `lock_${appData.quizType}_${appData.selectedJuz}`;
        const now = new Date().getTime();
        localStorage.setItem(lockKey, now);
    }

    async function validateAndStart() {
        if (!checkTestLock()) return;

        document.getElementById('main-loader').style.display = 'block';
        document.getElementById('master-start-btn').style.display = 'none';
        try {
            appData.questions = [];
            if(appData.quizType === 'culture') {
                appData.questions = shuffle([...culturalStore]).slice(0, 20).map(q => ({...q, opts: shuffle([...q.opts]), type: 'choice'}));
            } else {
                const res = await fetch(`https://api.alquran.cloud/v1/juz/${appData.selectedJuz}/quran-simple`);
                const json = await res.json();
                const ayahs = json.data.ayahs;
                appData.surahNamesInJuz = [...new Set(ayahs.map(a => a.surah.name))];
                let temp = [];
                while(temp.length < 20) {
                    let idx = Math.floor(Math.random() * (ayahs.length - 2));
                    let target = ayahs[idx];
                    if(appData.quizType === 'completion') {
                        temp.push({q: target.text, ans: ayahs[idx+1].text, opts: shuffle([ayahs[idx+1].text, ayahs[Math.floor(Math.random()*ayahs.length)].text, ayahs[Math.floor(Math.random()*ayahs.length)].text]), hint: `سورة ${target.surah.name} | آية ${target.numberInSurah}`, type: 'choice'});
                    } else if(appData.quizType === 'surahName') {
                        let others = shuffle(appData.surahNamesInJuz.filter(s => s !== target.surah.name));
                        temp.push({q: target.text, ans: target.surah.name, opts: shuffle([target.surah.name, others[0] || "الفاتحة", others[1] || "البقرة"]), hint: "في أي سورة وردت هذه الآية؟", type: 'choice'});
                    } else if(appData.quizType === 'terminator') {
                        let words = target.text.split(' ');
                        if(words.length >= 5) temp.push({q: words.slice(0, -2).join(' ') + " ...", ans: words.slice(-2).join(' '), hint: `فاصلة آية من سورة ${target.surah.name}:`, type: 'write'});
                    }
                }
                appData.questions = temp.slice(0, 20);
            }
            document.getElementById('main-loader').style.display = 'none';
            document.getElementById('screen-setup').classList.remove('active-screen');
            document.getElementById('screen-quiz').classList.add('active-screen');
            appData.currentIdx = 0; appData.score = 0;
            showQuestion();
        } catch(e) { alert("خطأ في الاتصال"); location.reload(); }
    }

    function showQuestion() {
        if(appData.currentIdx >= appData.questions.length) return showFinalResult();
        appData.isAnswering = false;
        const q = appData.questions[appData.currentIdx];
        document.getElementById('q-counter').innerText = `السؤال: ${appData.currentIdx + 1} / 20`;
        document.getElementById('q-hint').innerText = q.hint;
        document.getElementById('q-text').innerText = q.q;
        document.getElementById('reveal-ans').style.display = 'none';
        const area = document.getElementById('interaction-area');
        area.innerHTML = '';
        if(q.type === 'write') {
            appData.timeLeft = 45;
            const input = document.createElement('input');
            input.className = 'write-input'; input.id = 'write-field'; input.placeholder = 'اكتب الكلمتين الأخيرتين...';
            const btn = document.createElement('button');
            btn.className = 'submit-btn'; btn.id = 'write-submit'; btn.innerText = 'تأكيد الإجابة';
            btn.onclick = () => checkAnswer(input.value, input);
            area.appendChild(input); area.appendChild(btn);
            input.focus();
        } else {
            appData.timeLeft = 15;
            q.opts.forEach(opt => {
                const b = document.createElement('div');
                b.className = 'option-btn'; b.innerText = opt;
                b.onclick = () => checkAnswer(opt, b);
                area.appendChild(b);
            });
        }
        startTimer();
    }

    function startTimer() {
        document.getElementById('timer-display').innerText = appData.timeLeft;
        clearInterval(appData.timer);
        appData.timer = setInterval(() => {
            appData.timeLeft--;
            document.getElementById('timer-display').innerText = appData.timeLeft;
            if(appData.timeLeft <= 0) { clearInterval(appData.timer); if(!appData.isAnswering) checkAnswer("", null); }
        }, 1000);
    }

    function checkAnswer(userInput, element) {
        if(appData.isAnswering) return;
        appData.isAnswering = true; clearInterval(appData.timer);
        if(document.getElementById('write-submit')) document.getElementById('write-submit').disabled = true;
        const correct = appData.questions[appData.currentIdx].ans;
        const isCorrect = normalizeArabic(userInput) === normalizeArabic(correct);
        if(isCorrect) { appData.score++; if(element) element.classList.add('correct'); }
        else { if(element) element.classList.add('wrong'); const rev = document.getElementById('reveal-ans'); rev.innerText = "الصواب: " + correct; rev.style.display = 'block'; }
        setTimeout(() => { appData.currentIdx++; showQuestion(); }, 2000);
    }

    function showFinalResult() {
        saveTestDate();
        document.getElementById('screen-quiz').classList.remove('active-screen');
        document.getElementById('screen-result').classList.add('active-screen');
        
        const typeLabels = {
            'completion': 'أكمل الآية',
            'terminator': 'ضبط الفواصل',
            'surahName': 'ما اسم السورة؟',
            'culture': 'ثقافة قرآنية'
        };
        document.getElementById('cert-type-label').innerText = "نوع الاختبار: " + (typeLabels[appData.quizType] || "اختبار عام");
        
        document.getElementById('cert-user-name').innerText = appData.userName;
        document.getElementById('cert-user-country').innerText = appData.country;
        document.getElementById('cert-juz').innerText = appData.selectedJuz || "عام";
        document.getElementById('cert-score').innerText = appData.score;
        document.getElementById('cert-pts').innerText = appData.score * 10;
        document.getElementById('cert-date').innerText = new Date().toLocaleDateString('ar-EG');
        
        setTimeout(generatePreview, 800);
    }

    function generatePreview() {
        const cert = document.getElementById('cert-wrapper');
        cert.style.display = 'flex';
        html2canvas(cert, { scale: 1.5, useCORS: true, logging: false }).then(canvas => {
            document.getElementById('cert-preview').src = canvas.toDataURL("image/png");
            cert.style.display = 'none';
        });
    }

    function downloadCert() {
        const btn = document.getElementById('download-btn');
        btn.innerText = "جاري الحفظ..."; btn.disabled = true;
        const cert = document.getElementById('cert-wrapper');
        cert.style.display = 'flex';
        html2canvas(cert, { scale: 2.5, useCORS: true }).then(canvas => {
            const link = document.createElement('a');
            link.download = `شهادة_نفحات_${appData.userName}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
            cert.style.display = 'none';
            btn.innerText = "تم الحفظ بنجاح ✅";
            setTimeout(() => { btn.innerText = "حفظ الشهادة في الاستوديو"; btn.disabled = false; }, 3000);
        });
    }
</script>
</body>
</html>
